---
output:
  bookdown::pdf_document2:
    toc: yes
    number_sections: no
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    fig_caption: yes
    code_folding: hide
    number_sections: no
  html_document:
    toc: yes
    df_print: paged
  pdf_document:
    toc: yes
bibliography: ../library.bib
csl: apa6.csl
header-includes: \usepackage{caption} \renewcommand{\figurename}{Supplementary Figure} \renewcommand{\tablename}{Supplementary Table}
---

```{r, include = F}
knitr::opts_chunk$set(echo=F, warning=FALSE, message=FALSE, size="small")

opts <- options(knitr.kable.NA = "")
```

```{r, cache = F, include = F}
library(png)
library(grid)
library(xtable)
library(tidybayes)
library(ggridges)
library(glue)
library(brms)
library(stringr)
library(forcats)
library(ggthemes)
library(ggpubr)
library(reshape)
library(ggExtra)
library(tidybayes)
library(tidyboot)
library(MplusAutomation)
library(kableExtra)
library(knitr)
#library(magick)
#library(pdftools)
library(projpred)
library(bayesplot)
library(loo)
library(directlabels)
library(tidyverse)

source("../utils/custom_facet.R")

cor_func <- function(x) {
  x %>%
    corrr::correlate()%>%
    gather(time_point, cor, -term)%>%
    mutate(cor = replace(cor, duplicated(cor), NA))%>%
    drop_na(cor)
}

library(coda)

estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}

hdi_upper<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

hdi_lower<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}

read_csv("../saves/srm_estimates.csv")%>%mutate(subject = ifelse(subject == "changa", "shanga", subject))
```

```{r}
# read in data files
data_task <- read.csv("../data/laac2_data_task.csv")

data_trial <- read.csv("../data/laac2_data_trial.csv")


```

# Sample size

```{r}
data_task %>%
  group_by(group,time_point)%>%
  summarise(n = n_distinct(subject))%>%
  ggplot(., aes(x = factor(time_point), y= n,  fill = group))+
  geom_bar(stat = "identity",position = "stack")+
  scale_fill_ptol(name = "Group")+
  labs(x = "Time point", y = "Sample size")+
  theme_minimal()
```

# Performance based on Data

```{r}
time_plot_0 <- data_task%>%
  #filter(time_point < 5)%>%
  drop_na(performance)%>%
  group_by(subject, task, time_point, group)%>%
  summarise(mean = mean(performance,na.rm = TRUE))

time_plot_1 <- data_task%>%
  #filter(time_point < 5)%>%
  drop_na(performance)%>%
  group_by(task, time_point, group)%>%
  summarise(mean = mean(performance,na.rm = TRUE))

time_plot_2 <- data_task%>%
  #filter(time_point < 5)%>%
  drop_na(performance)%>%
  #mutate(time_point = factor(time_point))%>%
  group_by(task, time_point)%>%
  tidyboot_mean(col = performance, na.rm = TRUE)%>%
  mutate(chance = ifelse(task == "inhibit_searched", NA,ifelse(task == "communication", 1/3,0.5)))

ggplot()+
  facet_wrap(~task, ncol = 3, scales = "free_y")+
  #geom_vline(data = time_plot_2,aes(xintercept = 14.5), lty = 1, col = "black", alpha = 1, size = 1)+
  geom_hline(data = time_plot_2,aes(yintercept = chance), lty = 2, col = "black", alpha = .75)+
   geom_jitter(data = time_plot_0, aes(x = factor(time_point), y = mean,  col = group), alpha = .25, width = 0.2)+
  geom_point(data = time_plot_1, aes(x = factor(time_point), y = mean,  col = group), alpha = .6)+
  geom_line(data = time_plot_1, aes(x = factor(time_point), y = mean, col = group, group = group), alpha = .6)+
  geom_pointrange(data = time_plot_2, aes(x = factor(time_point), y = mean, ymin = ci_lower, ymax = ci_upper),pch = 4)+
  geom_line(data = time_plot_2, aes(x = factor(time_point), y = mean, group = task))+
  theme_minimal()+
    #geom_pointrange(data = switch_data, aes(x = time_point, y = mean, ymin = ci_lower, ymax = ci_upper, pch = phase), alpha = .5)+
  labs(x = "Time Point", y = "Performance")+
  #geom_line(data = switch_data, aes(x = time_point, y = mean, group = phase), alpha = .5)+
  guides(size = F)+
  #scale_shape(name = "Switching Phase")+
  scale_color_ptol(name = "Group")+
  #cale_x_continuous(breaks = c(1:max(time_plot_2$time_point)))+
  theme(legend.position = "bottom", panel.border = element_rect(colour = "black", fill=NA, size = .5))

```

# LS models

```{r, include=F}
# latent state models
lsa <- readModels("../outputs/laac2_LS_attent.out")
lsc <- readModels("../outputs/laac2_LS_comm.out")
lsp <- readModels("../outputs/laac2_LS_population.out")
lsr <- readModels("../outputs/laac2_LS_reason.out")
lsi <- readModels("../outputs/laac2_LS_search.out")
lsv <- readModels("../outputs/laac2_LS_food.out")

# latent state trait models
lsta <- readModels("../outputs/laac2_LST_attent.out")
lstc <- readModels("../outputs/laac2_LST_comm.out")
lstp <- readModels("../outputs/laac2_LST_population.out")
lstr <- readModels("../outputs/laac2_LST_reason.out")
lsti <- readModels("../outputs/laac2_LST_search_2.out")
lstv <- readModels("../outputs/laac2_LST_food.out")

# latent state trait models fixed variances varying means

lstaf <- readModels("../outputs/laac2_LST_attent_equalSvar.out")
lstcf <- readModels("../outputs/laac2_LST_comm_equal_Svar.out")
lstpf <- readModels("../outputs/laac2_LST_population_equalSvar.out")
lstrf <- readModels("../outputs/laac2_LST_reason_equalSvar.out")
lstif <- readModels("../outputs/laac2_LST_search_2_equalSvar.out")
lstvf <- readModels("../outputs/laac2_LST_food_equalSvar.out")

# latent state trait models equal variances varying means

lstav <- readModels("../outputs/laac2_LST_attent_equalSvar_means.out")
lstcv <- readModels("../outputs/laac2_LST_comm_equal_Svar_means.out")
lstpv <- readModels("../outputs/laac2_LST_population_equalSvar_means.out")
lstrv <- readModels("../outputs/laac2_LST_reason_equalSvar_means.out")
lstiv <- readModels("../outputs/laac2_LST_search_2_equalSvar_means.out")
lstvv <- readModels("../outputs/laac2_LST_food_equalSvar_means.out")



```



```{r}

plse <- bind_rows(
  lsa$parameters$unstandardized%>%mutate(task = "attention"),
  lsc$parameters$unstandardized%>%mutate(task = "communication"),
  lsp$parameters$unstandardized%>%mutate(task = "pop-to-sample"),
  lsr$parameters$unstandardized%>%mutate(task = "reasoning"),
  lsi$parameters$unstandardized%>%mutate(task = "inhibit-searched"),
  lsv$parameters$unstandardized%>%mutate(task = "visible-food"),
          # lsi$parameters$unstandardized%>%mutate(task = "inference"),
          # lsq$parameters$unstandardized%>%mutate(task = "quantity"),
          # lsg$parameters$unstandardized%>%mutate(task = "gaze_following")
)%>%
filter(paramHeader == "Means")%>%
  mutate(time_point = factor(as.numeric(gsub("[^0-9.-]", "", param))),
         estimate = "Latent state mean",
         ref = 0)


plsr <- bind_rows(
  lsa$parameters$r2%>%mutate(task = "attention"),
  lsc$parameters$r2%>%mutate(task = "communication"),
  lsp$parameters$r2%>%mutate(task = "pop-to-sample"),
  lsr$parameters$r2%>%mutate(task = "reasoning"),
  lsi$parameters$r2%>%mutate(task = "inhibit-searched"),
  lsv$parameters$r2%>%mutate(task = "visible-food"),
          # lsi$parameters$unstandardized%>%mutate(task = "inference"),
          # lsq$parameters$unstandardized%>%mutate(task = "quantity"),
          # lsg$parameters$unstandardized%>%mutate(task = "gaze_following")
)%>%
  slice(which(row_number() %% 2 == 1))%>%
  mutate(time_point = factor(as.numeric(str_remove(param, "P1"))),
         estimate = "Reliability",
         ref = NA)

bind_rows(plse, plsr)%>%
  ggplot(aes(x = time_point, y = est, col = task))+
  geom_hline(aes(yintercept = ref), lty = 2, alpha = .75)+
  labs(x = "Time point",y = "Estimate")+
  geom_line(aes(group = task),position = position_dodge(width = 0.2), alpha = .75)+
  geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci),position = position_dodge(width = 0.2), alpha = .75)+
  scale_color_colorblind(name = "Task")+
  facet_grid(task ~estimate)+
  facet_wrap_custom(estimate~., scales = "free_y", ncol = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(-4, 2.5))),
    scale_override(2, scale_y_continuous(limits = c(0, 1)))
  ))+
  theme_bw()


plse%>%
  ggplot(aes(x = time_point, y = est, col = task))+
  geom_hline(aes(yintercept = 0), lty = 2, alpha = .75)+
  labs(x = "Time point",y = "Latent State Mean")+
  geom_line(aes(group = task),position = position_dodge(width = 0.2), alpha = .75)+
  geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci),position = position_dodge(width = 0.2), alpha = .75)+
  scale_color_colorblind(name = "Task")+
  facet_wrap(~task)+
  #ylim(-4, 2.5)+
  theme_bw()
```

```{r}
plsr%>%
  ggplot(aes(x = time_point, y = est, col = task))+
  #geom_hline(aes(yintercept = ref), lty = 2, alpha = .75)+
  labs(x = "Time point",y = "Reliability")+
  geom_line(aes(group = task),position = position_dodge(width = 0.2), alpha = .75)+
  geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci),position = position_dodge(width = 0.2), alpha = .75)+
  scale_color_colorblind(name = "Task")+
  facet_wrap(~task)+
  ylim(0,1)+
  theme_bw()
```


```{r}
cor <- bind_rows(
  lsa$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "attention"),
    lsc$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "communication"),
      lsp$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "pop-to-sample"),
      lsr$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "reasoning"),
      lsi$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "inhibit-searched"),
      lsv$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "visible-food")
)%>%
  mutate(paramHeader = str_replace(paramHeader, "\\.WITH",""),
         paramHeader = factor(as.numeric(str_replace(paramHeader, "S",""))),
          param = factor(as.numeric(str_replace(param, "S",""))))#%>%
  # mutate(task = recode(task,
  #   gaze_following = "Gaze following",
  #   causality = "Causal inference",
  #   inference = "Inference by exclusion",
  #   delay_of_gratification = "Delay of gratification",
  #   quantity = "Quantity discrimination",
  #   switching = "Strategy switching"
  # ),
  # task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))

cor%>%
  ggplot(aes(y = paramHeader, x = param, fill = est))+
    geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "#FFE066", 
   midpoint = 0.5, limit = c(0,1), space = "Lab", 
   name="Correlation")+
  geom_text(aes(label = round(est, 2)), size = 2)+
  scale_y_discrete(limits=rev, breaks = c(1:10))+
  scale_x_discrete(breaks = c(1:9))+
  facet_wrap(~task, ncol = 2)+
  theme_few()+
  theme(legend.position = c(0.9,0.85), legend.direction = "vertical", legend.title = element_blank(), legend.background = element_blank())
```
# LST Models

## Varying variances

```{r}
bind_rows(
  lstc$parameters$unstandardized%>%
  filter(paramHeader == "Variances")%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  pivot_longer(cols = c(2:11), names_to = "time_point", values_to = "est")%>%
  mutate(consistency = `T`/(est + `T`))%>%select(time_point, consistency)%>%mutate(task = "communication"),
  
  lstv$parameters$unstandardized%>%
  filter(paramHeader == "Variances")%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  pivot_longer(cols = c(2:11), names_to = "time_point", values_to = "est")%>%
  mutate(consistency = `T`/(est + `T`))%>%select(time_point, consistency)%>%mutate(task = "visible-food"),
  
  lstr$parameters$unstandardized%>%
  filter(paramHeader == "Variances")%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  pivot_longer(cols = c(2:11), names_to = "time_point", values_to = "est")%>%
  mutate(consistency = `T`/(est + `T`))%>%select(time_point, consistency)%>%mutate(task = "reasoning"),
  
  
  lstp$parameters$unstandardized%>%
  filter(paramHeader == "Variances")%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  pivot_longer(cols = c(2:11), names_to = "time_point", values_to = "est")%>%
  mutate(consistency = `T`/(est + `T`))%>%select(time_point, consistency)%>%mutate(task = "pop-to-sample"),
  
  
  lsti$parameters$unstandardized%>%
  filter(paramHeader == "Variances")%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  pivot_longer(cols = c(2:11), names_to = "time_point", values_to = "est")%>%
  mutate(consistency = `T`/(est + `T`))%>%select(time_point, consistency)%>%mutate(task = "inhibit-searched"),
  
  lsta$parameters$unstandardized%>%
  filter(paramHeader == "Variances")%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  pivot_longer(cols = c(3:12), names_to = "time_point", values_to = "est")%>%
  mutate(consistency = ifelse(time_point %in% c("S1", "S2", "S3", "S4", "S5"), `T1`/(est + `T1`), `T2`/(est + `T2`)))%>%select(time_point, consistency)%>%mutate(task = "attention"),
  
  
)%>%mutate(time_point = factor(as.numeric(gsub("[^0-9.-]", "", time_point))))%>%
  # mutate(task = recode(task,
  #   gaze_following = "Gaze following",
  #   causality = "Causal inference",
  #   inference = "Inference by exclusion",
  #   delay_of_gratification = "Delay of gratification",
  #   quantity = "Quantity discrimination",
  #   switching = "Strategy switching"
  # ),
  # task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))%>%
  ggplot(aes(x = time_point, y = consistency, col = task))+
  geom_point(position = position_dodge(width = .9), size = 2)+
  geom_line(aes(group = task),position = position_dodge(width = 0.9), alpha = .75)+
  theme_bw()+
  ylim(0,1)+
  facet_wrap(~task)+
  labs(x = "Time point", y = "Consistency")+
  #scale_x_discrete(limits=rev)+
  scale_color_colorblind(name = "Task")
```

## Fixed variances, fixed means

```{r}
lstf_con_rel <- bind_rows(
  bind_rows(
  lstcf$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "communication"),
  
  
  lstvf$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "visible-food"),
  
  lstrf$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "reasoning"),
  
  
  lstpf$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "pop-to-sample"),
  
  
  lstif$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "inhibit-searched"),
  
  lstaf$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "attention"),
)%>%
  mutate(param = "consistency")%>%
  dplyr::rename(value = consistency),

bind_rows(
  lstcf$parameters$r2%>%filter(param == "P11")%>%mutate(task = "communication"),
  lstvf$parameters$r2%>%filter(param == "P11")%>%mutate(task = "visible-food"),
  lstrf$parameters$r2%>%filter(param == "P11")%>%mutate(task = "reasoning"),
  lstpf$parameters$r2%>%filter(param == "P11")%>%mutate(task = "pop-to-sample"),
  lstif$parameters$r2%>%filter(param == "P11")%>%mutate(task = "inhibit-searched"),
  lstaf$parameters$r2%>%filter(param == "P11")%>%mutate(task = "attention"),
)%>%
  mutate(param = "reliability")%>%
  dplyr::rename(value = est)%>%
  select(task, value, param,lower_2.5ci, upper_2.5ci)
)

ggplot(lstf_con_rel, aes(x = param, y = value, col = param))+
  geom_pointrange(aes(ymin= lower_2.5ci, ymax = upper_2.5ci))+
  theme_bw()+
  ylim(0,1)+
  facet_wrap(~task)+
  guides(col = "none")+
  ggtitle("Fixed variances, fixed means")+
  labs(x = "Time point", y = "Parameter estimate")+
  scale_color_colorblind(name = "Parameter")
```


## Fixed variances, varying means

```{r}
lstv_con_rel <- bind_rows(
  bind_rows(
  lstcv$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "communication"),
  
  
  lstvv$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "visible-food"),
  
  lstrv$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "reasoning"),
  
  
  lstpv$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "pop-to-sample"),
  
  
  lstiv$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "inhibit-searched"),
  
  lstav$parameters$unstandardized%>%
  filter(paramHeader == "Variances", 
         param %in% c("T", "S1"))%>%
  select(param, est)%>%
  pivot_wider(names_from = param, values_from = est)%>%
  mutate(consistency = `T`/(S1 + `T`))%>%select(consistency)%>%mutate(task = "attention"),
)%>%
  mutate(param = "consistency")%>%
  dplyr::rename(value = consistency),

bind_rows(
  lstcv$parameters$r2%>%filter(param == "P11")%>%mutate(task = "communication"),
  lstvv$parameters$r2%>%filter(param == "P11")%>%mutate(task = "visible-food"),
  lstrv$parameters$r2%>%filter(param == "P11")%>%mutate(task = "reasoning"),
  lstpv$parameters$r2%>%filter(param == "P11")%>%mutate(task = "pop-to-sample"),
  lstiv$parameters$r2%>%filter(param == "P11")%>%mutate(task = "inhibit-searched"),
  lstav$parameters$r2%>%filter(param == "P11")%>%mutate(task = "attention"),
)%>%
  mutate(param = "reliability")%>%
  dplyr::rename(value = est)%>%
  select(task, value, param,lower_2.5ci, upper_2.5ci)
)

ggplot(lstv_con_rel, aes(x = param, y = value, col = param))+
  geom_pointrange(aes(ymin= lower_2.5ci, ymax = upper_2.5ci))+
  theme_bw()+
  ylim(0,1)+
  facet_wrap(~task)+
  ggtitle("Fixed variances, varying means")+
  guides(col = "none")+
  labs(x = "Time point", y = "Parameter estimate")+
  scale_color_colorblind(name = "Parameter")
```

## Comparison fixed and varying means

```{r}
bind_rows(
lstf_con_rel%>%mutate(type = "fixed means"),
lstv_con_rel%>%mutate(type = "varying means")
)%>%
  ggplot(aes(x = param, y = value, col = param, pch = type))+
  geom_pointrange(aes(ymin= lower_2.5ci, ymax = upper_2.5ci), position = position_dodge(width = 0.9))+
  theme_bw()+
  ylim(0,1)+
  facet_wrap(~task)+
  guides(col = "none")+
  labs(x = "Time point", y = "Parameter estimate")+
  scale_color_colorblind(name = "Parameter")
```

```{r}
ggsave("../visuals/comp_fix_vary_means.png", height = 3, width = 5, scale = 1.5)
```

# Task level correlations

## Raw data

```{r}
data_task_r1 <- read_csv("../../laac/data/laac_data_task.csv")%>%
  filter(time_point > 14)

cor_dat <- bind_rows(
  
data_task_r1%>%
  filter(!grepl("switch", task))%>%
  group_by(subject, task)%>%
  summarise(perf = mean(performance, na.rm = T))%>%
  left_join(
    data_task_r1%>%
      dplyr::rename(task_1 = task)%>%
      group_by(subject, task_1)%>%
      summarise(perf_1 = mean(performance, na.rm = T))
    )%>%
  select(subject, task, task_1, perf, perf_1)%>%
  filter(!grepl("switch", task_1))%>%
  ungroup()%>%
  filter(task != task_1),
  
    
data_task%>%
  group_by(subject, task)%>%
  summarise(perf = mean(performance, na.rm = T))%>%
  left_join(
    data_task_r1%>%
      dplyr::rename(task_1 = task)%>%
      group_by(subject, task_1)%>%
      summarise(perf_1 = mean(performance, na.rm = T))
    )%>%
  select(subject, task, task_1, perf, perf_1)%>%
  ungroup()%>%
  filter(!grepl("switch", task_1)),

data_task_r1%>%
  group_by(subject, task)%>%
  summarise(perf = mean(performance, na.rm = T))%>%
  left_join(
    data_task%>%
      dplyr::rename(task_1 = task)%>%
      group_by(subject, task_1)%>%
      summarise(perf_1 = mean(performance, na.rm = T))
    )%>%
  select(subject, task, task_1, perf, perf_1)%>%
  ungroup()%>%
  filter(!grepl("switch", task)),

data_task%>%
  group_by(subject, task)%>%
  summarise(perf = mean(performance, na.rm = T))%>%
  left_join(
    data_task%>%
      dplyr::rename(task_1 = task)%>%
      group_by(subject, task_1)%>%
      summarise(perf_1 = mean(performance, na.rm = T))
    )%>%
  select(subject, task, task_1, perf, perf_1)%>%
  ungroup()%>%
  filter(task != task_1)

)%>%
  ungroup()%>%
  na.omit()%>%
  dplyr::group_by(task, task_1)%>%
  summarise(cor = cor.test(perf, perf_1)$estimate, 
            pval = cor.test(perf, perf_1)$p.value)%>%
  na.omit()%>%
  rowwise()%>%
  mutate(id = paste(sort(c(task, task_1)), collapse = " - "))%>%
  dplyr::ungroup()%>%
  dplyr::distinct(id, .keep_all = T)%>%
  mutate(sigd = ifelse(pval < 0.05, "bold", "plain"))

pcor_dat <- ggplot(cor_dat, aes(y = task, x = task_1, fill = cor))+
  geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "white", 
  midpoint = 0, limit = c(-1,1), space = "Lab", 
  name="Correlation")+
  ggtitle("Sum score based correlations")+
  geom_text(aes(label = round(cor, 2), fontface = sigd), size = 3)+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  #scale_y_discrete(limits=rev, breaks = c(1:10))+
  #scale_x_discrete(breaks = c(1:9))+
  theme_few()
  #theme(legend.position = c(0.9,0.85), legend.direction = "vertical", legend.title = element_blank(), legend.background = element_blank())
```

```{r}
ggsave("../visuals/task_level_cor.png", height = 5, width = 6, scale = 1.5)
```


## Model based

```{r}
cor_mod_raw <- readModels("../outputs/Trait_model_imp_test.out")

cor_mod <- cor_mod_raw$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%
  mutate(paramHeader = str_replace(paramHeader, "\\.WITH",""))%>%
  filter(paramHeader != "INF1", 
         param!= "INF1")%>%
  mutate(paramHeader = recode(paramHeader,
    ATTENT = "attention",
    GAZE = "gaze_following",
    CAUSE = "causality",
    INF2 = "inference",
    DELAY = "delay_of_gratification",
    COMM = "communication",
    SEARCH = "inhibit_searched",
    POP = "population",
    QUANT = "quantity",
    REASON = "reasoning",
    FOOD = "visible_food"
  ),
  param = recode(param,
    ATTENT = "attention",
    GAZE = "gaze_following",
    CAUSE = "causality",
    INF2 = "inference",
    DELAY = "delay_of_gratification",
    COMM = "communication",
    SEARCH = "inhibit_searched",
    POP = "population",
    QUANT = "quantity",
    REASON = "reasoning",
    FOOD = "visible_food"
  ))%>%
  rowwise()%>%
  mutate(id = paste(sort(c(paramHeader, param)), collapse = "-"))%>%
  separate(id, into = c("task", "task_1"), sep = "-")%>%
  arrange(task, task_1)%>%
  mutate(sig = ifelse(pval < 0.05, "bold", "plain"))

pcor_mod <- ggplot(cor_mod, aes(y = task, x = task_1, fill = est))+
  geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "white", 
  midpoint = 0, limit = c(-1,1), space = "Lab", 
  name="Correlation")+
  ggtitle("Model based correlations")+
  geom_text(aes(label = round(est, 2), fontface = sig), size = 3)+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  #scale_y_discrete(limits=rev, breaks = c(1:10))+
  #scale_x_discrete(breaks = c(1:9))+
  theme_few()
  #theme(legend.position = c(0.9,0.85), legend.direction = "vertical", legend.title = element_blank(), legend.background = element_blank())
```

```{r}
pdif <- cor_mod%>%
  left_join(cor_dat%>%select(-pval))%>%
  mutate(dif = est-cor, 
         dif_sig = ifelse(sig == sigd, "plain", "bold"))%>%
  ggplot(aes(y = task, x = task_1, fill = dif))+
  geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "orange", mid = "white", 
  midpoint = 0, limit = c(-0.5,0.5), space = "Lab", 
  name="Difference")+
  ggtitle("Difference: Model - Sum score")+
  geom_text(aes(label = round(dif, 2), fontface = dif_sig), size = 3)+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  #scale_y_discrete(limits=rev, breaks = c(1:10))+
  #scale_x_discrete(breaks = c(1:9))+
  theme_few()
```

```{r}
ggarrange(
  ggarrange(pcor_mod, pcor_dat), 
  ggarrange(NULL, pdif, NULL, widths = c(0.25, 0.5, 0.25), nrow = 1), 
  nrow = 2)
```
```{r}
ggsave("../visuals/compare_cor.png", height = 10, width = 12, scale = 1.25)
```

```{r}

cor_comp <- cor_mod%>%
  select(task, task_1, est)%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of grat.",
    quantity = "Quantity discrimination"
  ))%>%
  mutate(task_1 = recode(task_1,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of grat.",
    quantity = "Quantity discrimination"
  ))%>%
  left_join(readRDS("../../laac2/outputs/cor_mod_laac1.rds"))%>%
  na.omit()%>%
  mutate(dif = est - est_r1)

pcor_imp <- ggplot(cor_comp, aes(y = task, x = task_1, fill = est))+
  geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "white", 
  midpoint = 0, limit = c(-1,1), space = "Lab", 
  name="Correlation")+
  ggtitle("Imputation based correlations")+
  geom_text(aes(label = round(est, 2)), size = 3)+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  #scale_y_discrete(limits=rev, breaks = c(1:10))+
  #scale_x_discrete(breaks = c(1:9))+
  theme_few()


pcor_sem <- ggplot(cor_comp, aes(y = task, x = task_1, fill = est_r1))+
  geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "white", 
  midpoint = 0, limit = c(-1,1), space = "Lab", 
  name="Correlation")+
  ggtitle("SEM based correlations")+
  geom_text(aes(label = round(est_r1, 2)), size = 3)+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  #scale_y_discrete(limits=rev, breaks = c(1:10))+
  #scale_x_discrete(breaks = c(1:9))+
  theme_few()

pcor_dif_imp <- ggplot(cor_comp,aes(y = task, x = task_1, fill = dif))+
  geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "orange", mid = "white", 
  midpoint = 0, limit = c(-0.5,0.5), space = "Lab", 
  name="Difference")+
  ggtitle("Difference: Imputation - SEM")+
  geom_text(aes(label = round(dif, 2)), size = 3)+
  scale_x_discrete(guide = guide_axis(angle = 90))+
  #scale_y_discrete(limits=rev, breaks = c(1:10))+
  #scale_x_discrete(breaks = c(1:9))+
  theme_few()
  
```
```{r}
ggarrange(
  ggarrange(pcor_imp, pcor_sem), 
  ggarrange(NULL, pcor_dif_imp, NULL, widths = c(0.25, 0.5, 0.25), nrow = 1), 
  nrow = 2)
```

```{r}
ggsave("../visuals/compare_cor_imp_sem.png", height = 8, width = 10, scale = 1.5)
```


# Predictors

```{r}
df_trials <- data_trial%>%
  group_by(subject, time_point,group,test_tp, task, rank, sex, rearing, age, time_in_leipzig, observer, sick_severity,test_day, le_present, le_mean, le_max, dist_present, dist_mean, dist_max, time_outdoors, sociality)%>%
  summarise(sick_severity = mean(sick_severity), 
            p = sum(code), 
            n = length(code))%>%
  mutate(observer = ifelse(is.na(observer), "no", "yes"))
```


```{r}
grp_size <- read_csv("../saves/srm_estimates.csv")%>%
  group_by(species)%>%
  summarise(n = n_distinct(subject))%>%
  pivot_wider(names_from = species, values_from = n)
  

df_trials <- df_trials %>%
  # relative rank of ape within species (varies between time points)
  group_by(group, time_point) %>%
  mutate(
    rel_rank = case_when(
      group == "a_chimp" ~ percent_rank(grp_size$a_chimp:1)[rank],
      group == "b_chimp" ~ percent_rank(grp_size$b_chimp:1)[rank],
      group == "bonobos" ~ percent_rank(grp_size$bonobo:1)[rank],
      group == "gorillas" ~ percent_rank(grp_size$gorilla:1)[rank],
      group == "orangs" ~ percent_rank(grp_size$orang:1)[rank]
    )
  ) %>%
  ungroup()

df_trials_final <- df_trials %>%
  ungroup()%>%
  mutate(across(c(sick_severity,
                  test_tp,
                  rel_rank,
                  le_mean,
                  dist_mean,
                  time_outdoors,
                  age,
                  time_in_leipzig),
                ~scale(., center = T, scale = F))) %>%
  mutate(across(c(
                  subject,
                  group,
                  sex,
                  test_day,
                  le_present,
                  dist_present,
                  rearing,
                  observer),
                as_factor)) %>%
  mutate(observer = fct_relevel(observer, "no")) %>%
  mutate(rearing = fct_recode(rearing, "hand" = "unknown"))%>%
  left_join(read_csv("../saves/srm_estimates.csv")%>%
              mutate(subject = ifelse(subject == "changa", "shanga", subject))%>%
              select(subject, time_point, mean)%>%
              dplyr::rename("sociality" = "mean"))

```


```{r}
# formula for reference models
fm <- formula(p|trials(n) ~ sick_severity +
                #test_tp + 
                test_day +
                rel_rank +
                observer +
                age + time_in_leipzig +
                sex + group +
                rearing +
                le_mean + dist_mean +
                time_outdoors +
                sociality + 
                time_point +
                (1|subject))
```

```{r}
m_att <- brm(fm,
             family = binomial,
             data = df_trials_final%>%filter(task == "attention"),
              warmup = 1000, 
              iter = 4000, 
              cores = 4, 
              chains = 4,
              seed = 2024)

m_com <- brm(fm,
             family = binomial,
             data = df_trials_final%>%filter(task == "communication"),
              warmup = 1000, 
              iter = 4000, 
              cores = 4, 
              chains = 4,
              seed = 2024)

m_inh <- brm(fm,
             family = binomial,
             data = df_trials_final%>%filter(task == "inhibit_searched"),
              warmup = 1000, 
              iter = 4000, 
              cores = 4, 
              chains = 4,
              seed = 2024)

m_pop <- brm(fm,
             family = binomial,
             data = df_trials_final%>%filter(task == "population"),
              warmup = 1000, 
              iter = 4000, 
              cores = 4, 
              chains = 4,
              seed = 2024)

m_vis <- brm(fm,
             family = binomial,
             data = df_trials_final%>%filter(task == "visible_food"),
              warmup = 1000, 
              iter = 4000, 
              cores = 4, 
              chains = 4,
              seed = 2024)

```

```{r}
all_fixed_effects <- c("sick_severity",
                       #"test_tp", 
                       "test_day", "time_point",
                       "rel_rank",
                       "observer",
                       "age", "time_in_leipzig",
                       "sex", "group",
                       "rearing",
                       "le_mean", "dist_mean",
                       "time_outdoors",
                       "sociality")
# delay random intercept to last place so that it doesn't soak up all the variance
s_terms <- c("1", all_fixed_effects,
             paste0(paste(all_fixed_effects, collapse = " + "),
                    " + (1 | subject)"))
```


```{r, warning = FALSE}

doParallel::registerDoParallel(40)

cvs_att <- cv_varsel(m_att,
                     search_terms = s_terms,
                     validate_search = T,
                     cv_method = "LOO", 
                     method = "forward",
                     parallel = TRUE,
                     seed = 2024)
 
saveRDS(cvs_att,"./saves/cvs_att.rds")

doParallel::registerDoParallel(40)

cvs_com <- cv_varsel(m_com,
                     search_terms = s_terms,
                     validate_search = T,
                     cv_method = "LOO", 
                     method = "forward",
                     parallel = TRUE,
                     seed = 2024)
 
saveRDS(cvs_com,"./saves/cvs_com.rds")

doParallel::registerDoParallel(40)

cvs_inh <- cv_varsel(m_inh,
                     search_terms = s_terms,
                     validate_search = T,
                     cv_method = "LOO", 
                     method = "forward",
                     parallel = TRUE,
                     seed = 2024)
 
saveRDS(cvs_inh,"./saves/cvs_inh.rds")

doParallel::registerDoParallel(40)

cvs_pop <- cv_varsel(m_pop,
                     search_terms = s_terms,
                     validate_search = T,
                     cv_method = "LOO", 
                     method = "forward",
                     parallel = TRUE,
                     seed = 2024)
 
saveRDS(cvs_pop,"./saves/cvs_pop.rds")


doParallel::registerDoParallel(40)

cvs_vis <- cv_varsel(m_vis,
                     search_terms = s_terms,
                     validate_search = T,
                     cv_method = "LOO", 
                     method = "forward",
                     parallel = TRUE,
                     seed = 2024)
 
saveRDS(cvs_vis,"./saves/cvs_vis.rds")

```

```{r}

# cvs_cau <- readRDS("./saves/cvs_cau.rds")
```


```{r}
plot(cvs_att, stats = "elpd", ranking_nterms_max = NA)
plot(cvs_att, stats = "elpd", deltas = TRUE)

smmry <- summary(cvs_att, stats = "elpd", type = c("mean", "se", "diff", "diff.se"),
                 deltas = T)

print(smmry, digits = 1)

rk <- ranking(cvs_att)

pr_rk <- cv_proportions(rk)
```


# old

```{r}
mot <- bind_rows(
  tibble(
  Task = c("causality", ""),
  Model = c("LSM","LSTM"),
  PPP = c(lsc$summaries$PostPred_PValue,lstc$summaries$PostPred_PValue),
  `Chi 95% CI` = c(paste(lsc$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lsc$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
                           paste(lstc$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstc$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "))),
  tibble(
  Task = c("inference", ""),
  Model = c("LSM","LSTM"),
  PPP = c(lsi$summaries$PostPred_PValue,lsti$summaries$PostPred_PValue),
  `Chi 95% CI` = c(paste(lsi$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lsi$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
                           paste(lsti$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lsti$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "))),
  tibble(
  Task = c("gaze_following", ""),
  Model = c("LSM","LSTM"),
  PPP = c(lsg$summaries$PostPred_PValue,lstg$summaries$PostPred_PValue),
  `Chi 95% CI` = c(paste(lsg$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lsg$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
                           paste(lstg$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstg$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "))),
  tibble(
  Task = c("quantity", ""),
  Model = c("LSM","LSTM"),
  PPP = c(lsq$summaries$PostPred_PValue,lstq$summaries$PostPred_PValue),
  `Chi 95% CI` = c(paste(lsq$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lsq$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
                           paste(lstq$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstq$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; ")))
)%>%
  mutate(Task = recode(Task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))

```

```{r semt}
kable(mot, align = c("l", "l", "c", "c"), caption = "Model fit indices Phase 1", booktabs=TRUE)%>%
kable_classic(full_width = F)%>%
      footnote(c("LSM = Latent state model", "LSTM = Latent state-trait model", "PPP = Posterior predictive p-value. Cut-off values (two-tailed): 0.025 and 0.975", "Chi 95% CI = 95%CI of difference between predicted and observed chi-square values"))
```

```{r}
thresh <- bind_rows(
  bind_rows(
    lsc$parameters$unstandardized%>%mutate(Model = "LSM", Task = "causality"),
    lstc$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est),
  
    bind_rows(
    lsi$parameters$unstandardized%>%mutate(Model = "LSM", Task = "inference"),
    lsti$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est),
  
    bind_rows(
    lsg$parameters$unstandardized%>%mutate(Model = "LSM", Task = "gaze_following"),
    lstg$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est),
  
    bind_rows(
    lsq$parameters$unstandardized%>%mutate(Model = "LSM", Task = "quantity"),
    lstq$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est)
)%>%
  mutate(Task = recode(Task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))%>%mutate_all(~replace(., is.na(.), ""))


```

```{r thresht}
kable(thresh, caption = "Threshold parameters Phase 1", align = c("l", "l", "c", "c", "c", "c", "c", "c"), booktabs=TRUE)%>%
kable_classic(full_width = F)%>%
      footnote(c("LSM = Latent state model", "LSTM = Latent state-trait model", "T1-6 = Threshold parameters for response categories"))
```

#### Direct causal inference

To fit the models, the response categories of 0 or 1 solved trial had to be collapsed into one category due to sparsity. Furthermore, the thresholds could not be set equal for test-half 2 at time point 3 and 11 as well as test-half 1 at time points 4 and 12 due to a different number of observed categories for the respective test halves and time point combination. Latent means can still be compared across time for the state factors based on the respective other test half. At time point 7, thresholds of both test-halves could not be set invariant across time (due to a divergent number of observed categories). Latent mean differences for the latent state variable at time point 7 should therefore be interpreted with caution.

Supplementary Figure \@ref(fig:lseplot) visualizes the latent state means and reliability estimates from the LS model. Reliability was consistently acceptable to good. Only one of the latent means was significantly different from zero, suggesting robust task-level performance and no systematic mean change over time. Supplementary Figure \@ref(fig:lsplot) gives the correlations between the latent states for the different time points. Correlations were generally very high, indicating stable individual differences.

```{r}
plse <- bind_rows(lsc$parameters$unstandardized%>%mutate(task = "causality"),
          lsi$parameters$unstandardized%>%mutate(task = "inference"),
          lsq$parameters$unstandardized%>%mutate(task = "quantity"),
          lsg$parameters$unstandardized%>%mutate(task = "gaze_following"))%>%
filter(paramHeader == "Means")%>%
  mutate(time_point = factor(as.numeric(gsub("[^0-9.-]", "", param))),
         estimate = "Latent state mean",
         ref = 0)%>%
  filter(!(task == "gaze_following" & time_point == 8),
         !(task == "causality" & time_point == 7))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))

plsr <- bind_rows(lsc$parameters$r2%>%mutate(task = "causality"),
          lsi$parameters$r2%>%mutate(task = "inference"),
          lsq$parameters$r2%>%mutate(task = "quantity"),
          lsg$parameters$r2%>%mutate(task = "gaze_following"))%>%
  slice(which(row_number() %% 2 == 1))%>%
  mutate(time_point = factor(str_remove(param, "P1")),
         estimate = "Reliability",
         ref = NA)%>%
  filter(!(task == "gaze_following" & time_point == 8),
         !(task == "causality" & time_point == 7))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))
  
plser <- 
  bind_rows(plse, plsr)%>%
  ggplot(aes(x = time_point, y = est, col = task))+
  facet_wrap_custom(estimate~., scales = "free_y", ncol = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(-5, 1))),
    scale_override(2, scale_y_continuous(limits = c(0, 1)))
  ))+
  geom_hline(aes(yintercept = ref), lty = 2, alpha = .75)+
  labs(x = "Time point",y = "Estimate")+
  geom_line(aes(group = task),position = position_dodge(width = 0.2), alpha = .75)+
  geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci),position = position_dodge(width = 0.2), alpha = .75)+
  scale_color_colorblind(name = "Task")+
  theme_minimal()
```

```{r lseplot, fig.height = 4, fig.cap = "Phase 1: latent means and reliability estimates with 95\\% CI for each time point based on LSM. The sample size varied between time points and can be found in Supplementary Figure 1. Means at time point 1 are set to 0.", out.width="100%"}
plser
```

In the LST model, the consistency coefficient was estimated to be around .903. This means that around 90% of true inter-individual differences are attributable to stable (trait) differences between individuals, while approximately 10% are due to variance in time point specific deviations from the stable trait. Reliability (across time points) was estimated to be acceptable to good with a mean of .725 (see Supplementary Figure \@ref(fig:lsteplot)).

In sum, all models converge on the conclusion that group- and individual-level performance was highly stable over time. As noted above -- and as can be seen in Supplementary Figure \@ref(fig:perfplot) -- performance on a task level was clearly above chance.

```{r}
cor <- bind_rows(
  lsc$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "causality"),
  lsi$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "inference"),
  lsq$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "quantity"),
  lsg$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "gaze_following")
)%>%
  mutate(paramHeader = str_replace(paramHeader, "\\.WITH",""),
         paramHeader = factor(as.numeric(str_replace(paramHeader, "S",""))),
         param = factor(as.numeric(str_replace(param, "S",""))))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))

plsc <- cor%>%
  ggplot(aes(y = paramHeader, x = param, fill = est))+
    geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "#FFE066", 
   midpoint = 0.5, limit = c(0,1), space = "Lab", 
   name="Correlation")+
  geom_text(aes(label = round(est, 2)), size = 2)+
  scale_y_discrete(limits=rev, breaks = c(2,14))+
  scale_x_discrete(breaks = c(1,13))+
  facet_wrap(~task, ncol = 2)+
  theme_few()+
  theme(legend.position = c(0.9,0.85), legend.direction = "vertical", legend.title = element_blank(), legend.background = element_blank())
```

```{r lsplot, fig.height=6, fig.cap = "Phase 1: correlations between latent state variables based on LSM for the different tasks.", out.width="100%"}
plsc
```

#### Inference by exclusion

Thresholds could not be set equal for test half 2 at time point 6 as well as test half 1 at time points 7 and 14, due to a different number of observed categories for the respective test halves and time-point combination. Latent means can still be compared across time for the respective state factors based on the other test half.

Reliability was good in the LS model and none of the latent means differed from zero (Supplementary Figure  \@ref(fig:lseplot)). Correlations between latent states were generally high across time points (Supplementary Figure \@ref(fig:lsplot)).

In the LST model, consistency was estimated to be around .859 -- around 86% of true inter-individual differences were attributable to stable (trait) differences between individuals. Approximately 14% were due to variance in time-point specific deviations from the stable trait. Reliability was good with an estimate of .815 (see Supplementary Figure \@ref(fig:lsteplot)).

Taken together, we saw a similar pattern as for the direct causal inference task: Performance was very robust on a task level and so were the differences between individuals. Interestingly, from Supplementary Figure \@ref(fig:perfplot) we take that task-level performance was at chance. The stable individual differences we found here suggest that variation around this mean was systematic and therefore that some individuals consistently performed above chance. Thus, despite the fact that this task was very difficult for apes, it was suitable to measure individual differences.

```{r}
plste <- bind_rows(
  lstc$parameters$unstandardized%>%mutate(task = "causality"),
  lsti$parameters$unstandardized%>%mutate(task = "inference"),
  lstq$parameters$unstandardized%>%mutate(task = "quantity"),
  lstg$parameters$unstandardized%>%mutate(task = "gaze_following")
  )%>%
  filter(paramHeader== "New.Additional.Parameters",
         !grepl("DIF",param))%>%
  mutate(param = recode(param, CON1 = "Consistency", OCC1 = "Occasion specificity", REL1 = "Reliability"))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))%>%
  ggplot(aes(x = param, y = est, col = task))+
    geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci), position = position_dodge(width = .9))+
  theme_minimal()+
  ylim(0,1)+
  facet_grid(~param, scales = "free_x")+
  labs(x = "", y = "Model estiamte")+
  scale_x_discrete(limits=rev)+
  theme(axis.text.x = element_blank(), legend.position = "right")+
  scale_color_colorblind(name = "Task")
```

```{r lsteplot, fig.height = 3.5, fig.cap = "Phase 1: Posterior mean for model parameters (with 95\\% CrI) from LSTM for the four tasks based on data from N = 43 participants.", out.width="100%"}
plste
```

#### Gaze following

For gaze following, we had only 8 observed trials per measurement occasion. The highest two categories (3 and 4 correctly solved trials) were collapsed into one category due to sparsity. Thresholds could not be set equal for test half 2 at time point 9 as well as test half 1 and test half 2 at time point 8, due to a different number of observed categories for the respective test half and time point combination. Latent means can still be compared across time with the exception of time point 8.

Latent state means estimated in the LS model varied between -0.990 and -2.153. All of the latent state means were significantly lower than zero, suggesting a decrease in gaze following after the second time point (Supplementary Figure \@ref(fig:lseplot)). Reliability was acceptable to good for all time points. The correlations between latent states for the different time points were generally high, pointing to stable individual differences (Supplementary Figure \@ref(fig:lsplot)).

In the LST model, consistency was estimated to be around .758, that is around 76% of true inter-individual differences are attributable to stable differences between individuals. Approximately 24% of inter-individual differences were due to variance in time point specific deviations from the stable trait. Reliability was good with an estimate of .792.

In sum, we see a change in gaze following over time (Supplementary Figure \@ref(fig:perfplot)). This task-level effect, however, did not affect differences between individuals, which were systematic across time points.

#### Quantity discrimination

The lowest three (out of seven possible) categories (0, 1 and 2 correctly solved trials per test half) were collapsed due to sparsity. Thresholds could not be set equal for test half 1 at time point 5, due to a different number of observed categories for the respective test half and time-point combination. Latent means can still be compared across time.

Latent state means estimated in the LS model varied very little and all lay between -0.058 and 0.369. None of these state means differed from zero (Supplementary Figure \@ref(fig:lseplot)). Reliability estimates were substantially lower compared to the other tasks.

The consistency coefficient was estimated to be around .964, that is around 96% of true inter-individual differences was attributable to stable differences between individuals and only approximately 3.6% were due to variance in time-point specific deviations from the stable trait. Again, reliability was rather low with an estimate of .446.

Taken together, quantity judgments were very robust over time on the task level (see also Supplementary Figure \@ref(fig:perfplot)). The low reliability estimates suggest, however, that the task is less suited to capture individual differences.

### Phase 2

```{r, include=F}
# latent state models
lsc2 <- readModels("../supplement/saves/test_apes_data_LS_cau_2.out")
lsi2 <- readModels("../supplement/saves/test_apes_data_LS_inf_2.out")
lsq2 <- readModels("../supplement/saves/test_apes_data_LS_quant_2.out")
lsg2 <- readModels("../supplement/saves/test_apes_data_LS_gaze_2.out")
lsd2 <- readModels("../supplement/saves/test_apes_data_LS_delay_2.out")

# latent state trait models
lstc2 <- readModels("../supplement/saves/test_apes_data_LST_cau_equSvar_2.out")
lsti2 <- readModels("../supplement/saves/test_apes_data_LST_inf_equSvar_2.out")
lstq2 <- readModels("../supplement/saves/test_apes_data_LST_quant_equSvar_2.out")
lstg2 <- readModels("../supplement/saves/test_apes_data_LST_gaze_equSvar_2.out")
lstd2 <- readModels("../supplement/saves/test_apes_data_LST_delay_equSvar_2.out")
lsti2p2 <- readModels("../supplement/saves/test_apes_data_LST_inf_equSvar_2phases_2.out")

```

For a visual overview of task-level performance in the different tasks see Supplementary Figure \@ref(fig:perfplot). The pattern observed in Phase 1 was similar in Phase 2 for causal reasoning and quantity discrimination. The rate of gaze following remained on the low level reached at the end of Phase 1. For inference by exclusion, there was an increase in performance over time, which already began to show itself at the end of Phase 1. Taken together, there was a lot of continuity between Phase 1 and 2. The newly added delay of gratification task produced fairly variable results -- with no ceiling or floor effect.

Correlations between time points were similar in Phase 1 and 2 for all tasks (Supplementary Figure \@ref(fig:relplot)). Performance in the delay of gratification task proofed to be stable between individuals. Next, we present the results from the SEMs separate for each task. All models showed acceptable fit indices, except for the LST model for inference by exclusion (seeSupplementary Table \@ref(tab:semt2)). We therefore adjusted the LST model for this task in a way we describe below. The threshold parameters for each model are shown in Supplementary Table \@ref(tab:thresht2).

```{r}
mot2 <- bind_rows(
  tibble(
  Task = c("causality", ""),
  Model = c("LSM","LSTM"),
  PPP = c(lsc2$summaries$PostPred_PValue,lstc2$summaries$PostPred_PValue),
  `Chi 95% CI` = c(
    paste(lsc2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lsc2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstc2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lstc2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "))),
  
tibble(
  Task = c("inference", ""),
  Model = c("LSM","LSTM (2 parts)"),
  PPP = c(lsi2$summaries$PostPred_PValue,lsti2p2$summaries$PostPred_PValue),
  `Chi 95% CI` = c(
    paste(lsi$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lsi$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lsti2p2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lsti2p2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "))),
  
tibble(
  Task = c("gaze_following", ""),
  Model = c("LSM","LSTM"),
  PPP = c(lsg2$summaries$PostPred_PValue,lstg2$summaries$PostPred_PValue),
  `Chi 95% CI` = c(
    paste(lsg2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lsg2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstg2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lstg2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "))),
  
tibble(
  Task = c("quantity", ""),
  Model = c("LSM","LSTM"),
  PPP = c(lsq2$summaries$PostPred_PValue,lstq2$summaries$PostPred_PValue),
  `Chi 95% CI` = c(
    paste(lsq2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lsq2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstq2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lstq2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "))),
      
tibble(
  Task = c("delay_of_gratification", ""),
  Model = c("LSM","LSTM"),
  PPP = c(lsd2$summaries$PostPred_PValue,lstd2$summaries$PostPred_PValue),
  `Chi 95% CI` = c(
    paste(lsd2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lsd2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstd2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
          lstd2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; ")))
)%>%
  mutate(Task = recode(Task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))

```

```{r semt2}
kable(mot2, align = c("l", "l", "c", "c"), caption = "Model fit indices Phase 2", booktabs=TRUE)%>%
kable_classic(full_width = F)%>%
      footnote(c("LSM = Latent state model", "LSTM = Latent state-trait model", "PPP = Posterior predictive p-value. Cut-off values (two-tailed): 0.025 and 0.975", "Chi 95% CI = 95%CI of difference between predicted and observed chi-square values"))
```

```{r}
thresh2 <- bind_rows(
  bind_rows(
    lsc2$parameters$unstandardized%>%mutate(Model = "LSM", Task = "causality"),
    lstc2$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est),
  
    bind_rows(
    lsi2$parameters$unstandardized%>%mutate(Model = "LSM", Task = "inference"),
    lsti2p2$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est),
  
    bind_rows(
    lsg2$parameters$unstandardized%>%mutate(Model = "LSM", Task = "gaze_following"),
    lstg2$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est),
  
    bind_rows(
    lsq2$parameters$unstandardized%>%mutate(Model = "LSM", Task = "quantity"),
    lstq2$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est),
  
    bind_rows(
    lsd2$parameters$unstandardized%>%mutate(Model = "LSM", Task = "delay_of_gratification"),
    lstd2$parameters$unstandardized%>%mutate(Model = "LSTM", Task = ""))%>%
    filter(paramHeader=="Thresholds")%>%
    select(Task, Model, param, est)%>%
    filter(grepl("P11\\$",param))%>%
    separate(param,into = c("tp","Threshold"), sep = "\\$")%>%
    mutate(Threshold = paste("T", Threshold, sep = ""))%>%
    select(-tp)%>%
    pivot_wider(names_from = Threshold, values_from = est)
)%>%
  mutate(Task = recode(Task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))%>%
  mutate_all(~replace(., is.na(.), ""))


```

```{r thresht2}
kable(thresh2, caption = "Threshold parameters Phase 2", align = c("l", "l", "c", "c", "c", "c", "c", "c"), booktabs=TRUE)%>%
kable_classic(full_width = F)%>%
      footnote(c("LSM = Latent state model", "LSTM = Latent state-trait model", "LSTM-AR = LST model with autoregressive component", "T1-6 = Threshold parameters for response categories"))
```

#### Direct causal inference

As in phase 1, the lowest two categories (0 and 1 correctly solved trials per test half) were collapsed due to sparsity. Thresholds could not be set equal for test half 1 at time point 5, 8, and 11 as well as test half 2 at time point 14 (of phase 2), due to a different number of observed categories for the respective test half and time-point combination. Latent means can still be compared across time.

Supplementary Figure \@ref(fig:lseplot2) visualizes the latent state means and reliability estimates from the LS model. Reliability was consistently acceptable to good. Except for time point 2, none of the latent means was significantly different from zero, suggesting robust task-level performance and no systematic mean change over time. Supplementary Figure \@ref(fig:lsplot2) gives the correlations between the latent states for the different time points. Correlations were generally high -- indicating stable individual differences -- with a trend towards lower correlations for time points further apart.

In the LST model, the consistency coefficient was estimated to be around .912. This means that around 91% of true inter-individual differences are attributable to stable (trait) differences between individuals, while approximately 9% are due to variance in time point specific deviations from the stable trait. Reliability was estimated to be adequate with a value of .726 (see Supplementary Figure \@ref(fig:lsteplot2)).

In sum, the results suggest that task-level results were robust and individual-level performance was relatively stable over time. As noted above -- and as can be seen in Supplementary Figure \@ref(fig:perfplot) -- performance on a task level was clearly above chance.

```{r}
plse2 <- bind_rows(lsc2$parameters$unstandardized%>%mutate(task = "causality"),
          lsi2$parameters$unstandardized%>%mutate(task = "inference"),
          lsq2$parameters$unstandardized%>%mutate(task = "quantity"),
          lsg2$parameters$unstandardized%>%mutate(task = "gaze_following"),
          lsd2$parameters$unstandardized%>%mutate(task = "delay_of_gratification"))%>%
filter(paramHeader == "Means")%>%
  mutate(time_point = factor(as.numeric(gsub("[^0-9.-]", "", param))),
         estimate = "Latent state mean",
         ref = 0)%>%
  filter(!(task == "gaze_following" & time_point == 3))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))

plsr2 <- bind_rows(lsc2$parameters$r2%>%mutate(task = "causality"),
          lsi2$parameters$r2%>%mutate(task = "inference"),
          lsq2$parameters$r2%>%mutate(task = "quantity"),
          lsg2$parameters$r2%>%mutate(task = "gaze_following"),
          lsd2$parameters$r2%>%mutate(task = "delay_of_gratification"))%>%
  slice(which(row_number() %% 2 == 1))%>%
  mutate(time_point = factor(str_remove(param, "P1")),
         estimate = "Reliability",
         ref = NA)%>%
  filter(!(task == "gaze_following" & time_point == 3))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))
  
plser2 <- 
  bind_rows(plse2, plsr2)%>%
  ggplot(aes(x = time_point, y = est, col = task))+
  facet_wrap_custom(estimate~., scales = "free_y", ncol = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(-3, 2.2))),
    scale_override(2, scale_y_continuous(limits = c(0, 1)))
  ))+
  geom_hline(aes(yintercept = ref), lty = 2, alpha = .75)+
  labs(x = "Time point",y = "Estimate")+
  geom_line(aes(group = task),position = position_dodge(width = 0.2), alpha = .75)+
  geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci),position = position_dodge(width = 0.2), alpha = .75)+
  scale_color_colorblind(name = "Task")+
  theme_minimal()
```

```{r lseplot2, fig.height = 4, fig.cap = "Phase 2: latent means and reliability estimates with 95\\% CI for each time point based on LSM. The sample size varied between time points and can be found in Supplementary Figure 1. Means at time point 1 are set to 0.", out.width="100%"}
plser2
```

```{r}
cor2 <- bind_rows(
  lsc2$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "causality"),
  lsi2$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "inference"),
  lsq2$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "quantity"),
  lsg2$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "gaze_following"),
    lsd2$parameters$stdyx.standardized%>%filter(grepl("WITH",paramHeader))%>%mutate(task = "delay_of_gratification")
)%>%
  mutate(paramHeader = str_replace(paramHeader, "\\.WITH",""),
         paramHeader = factor(as.numeric(str_replace(paramHeader, "S",""))),
         param = factor(as.numeric(str_replace(param, "S",""))))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))

plsc2 <- cor2%>%
  ggplot(aes(y = paramHeader, x = param, fill = est))+
    geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "#FFE066", 
   midpoint = 0.5, limit = c(0,1), space = "Lab", 
   name="Correlation")+
  geom_text(aes(label = round(est, 2)), size = 2)+
  scale_y_discrete(limits=rev, breaks = c(2,14))+
  scale_x_discrete(breaks = c(1,13))+
  facet_wrap(~task, ncol = 2)+
  theme_few()+
  theme(legend.position = c(0.7,0.15), legend.direction = "horizontal", legend.title = element_blank(), legend.background = element_blank())
```

```{r lsplot2, fig.height=6, fig.cap = "Phase 2: correlations between latent state variables based on LSM for the different tasks.", out.width="100%"}
plsc2
```

#### Inference by exclusion

The lowest two categories (0 and 1 correctly solved trials per test half) were collapsed due to sparsity. Thresholds could not be set equal for test half 1 at time point 13, due to a different number of observed categories for the respective test half and time-point combination. Latent means can still be compared across time.

The latent state means shown in Supplementary Figure \@ref(fig:lseplot2) reflect the increase in performance over time that was also noted in Supplementary Figure \@ref(fig:perfplot). From time point 6 onward, all latent state means were estimated to be significantly different from zero. Reliability was consistently good. The latent state correlations shown in Supplementary Figure \@ref(fig:lsplot2) suggest that there was a split in the data in that there were high correlations between latent states among the time points smaller than 8 as well as among time points larger than 8. Looking at Supplementary Figure \@ref(fig:perfplot), we can see that the increase in task-level performance started around that time and was largely driven by individuals from the B-chimpanzee group. What this suggests is that some individuals improved in performance and then retained a higher level for the rest of the study. Some of the orangutans changed in the other direction, though to a lesser extend.

With a PPP of `r lsti2$summaries$PostPred_PValue`, the LST model for inference by exclusion did not provide a good fit to the data. We suspect the change in performance by some individuals that we discussed above to be responsible for that. That is, the assumption that a single, time invariant trait underlies performance at all time points seemed to be violated. We therefore fit an adjusted LST model for which we estimated one trait for time points 1 to 8 and a second trait for time points 9 to 14. As a consequence, we get two values for each LST model coefficient (one for each part) as well as a correlation between the two traits.

The adjusted model provided an acceptable fit to the data (see Supplementary Table \@ref(tab:semt2)). The consistency coefficients were very similar for the two parts: .912 (Part 1) and .928 (Part 2). That is, for both parts, more than 90% of true inter-individual differences are attributable to stable (trait) differences between individuals, while less than 10% are due to variance in time point specific deviations from the stable trait. The latent trait from the two parts correlated to $r = .815$. The mean of the latent trait variable of part 2 was 0.625 (that is, 0.625 higher than in part 1) and significantly different from zero. Reliability was estimated to be good for both parts: .800 (Part 1) and .830 (Part 2) (see Supplementary Figure \@ref(fig:lsteplot2)).

In sum, the models suggest that there was an increase in task-level performance over time which resulted in consistent above-chance performance in later time points (see Supplementary Figure \@ref(fig:perfplot)). This change was apparently driven by a few individuals who quickly improved and thereby changed their relative ranks. This resulted in a split in the data, with inter-individual differences in each part being quite stable.

```{r}
plste2 <- bind_rows(
  lstc2$parameters$unstandardized%>%mutate(task = "causality"),
  #lsti2$parameters$unstandardized%>%mutate(task = "inference"),
  lstq2$parameters$unstandardized%>%mutate(task = "quantity"),
  lstg2$parameters$unstandardized%>%mutate(task = "gaze_following"),
  lstd2$parameters$unstandardized%>%mutate(task = "delay_of_gratification")
  )%>%
  mutate(task = factor(task, levels = c("causality", "gaze_following", "inference", "quantity", "delay_of_gratification")))%>%
  filter(paramHeader== "New.Additional.Parameters",
         !grepl("DIF",param))%>%
  mutate(param = recode(param, CON1 = "Consistency", OCC1 = "Occasion specificity", REL1 = "Reliability"))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))%>%
  mutate(part = "Part 1")%>%
  bind_rows(lsti2p2$parameters$unstandardized%>%mutate(task = "inference", phase = "Phase 2")%>%
  filter(paramHeader== "New.Additional.Parameters",
         !grepl("DIF",param))%>%
  mutate(part = ifelse(grepl("1", param), "Part 1", "Part 2"),
         param = recode(param, CON1 = "Consistency", OCC1 = "Occasion specificity", REL1 = "Reliability",CON2 = "Consistency", OCC2 = "Occasion specificity", REL2 = "Reliability"),
         task = "Inference by exclusion"))%>%
  mutate(task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination", "Delay of gratification")))%>%
  ggplot(aes(x = param, y = est, col = task, pch = part))+
    geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci), position = position_dodge(width = .9))+
  theme_minimal()+
  ylim(0,1)+
  facet_grid(~param, scales = "free_x")+
  labs(x = "", y = "Model estiamte")+
    scale_shape(name = "")+
  scale_x_discrete(limits=rev)+
  theme(axis.text.x = element_blank(), legend.position = "right")+
  scale_color_colorblind(name = "Task")
```

```{r lsteplot2, fig.height = 3.5, fig.cap = "Phase 2: posterior means of model parameters (with 95\\% CI) from LST model for the four tasks based on data from N = 43 participants.", out.width="100%"}
plste2
```

#### Gaze following

As in phase 1, the highest two categories (3 and 4 correctly solved trials) were collapsed into one category due to sparsity. Thresholds could not be set equal for test half 2 at time point 1, 4, and 8, test half 1 at time point 9, as well as test half 1 and 2 at time point 3, due to a different number of observed categories for the respective test half and time point combination. Latent means can still be compared across time with the exception of time point 3.

None of the latent state means -- except for time point 14 -- were significantly different from zero, suggesting a robust average level of gaze following in Phase 2 (Supplementary Figure \@ref(fig:lseplot2)). Reliability varied between acceptable and high, ranging between `r min(plsr2%>%filter(task == "Gaze following")%>%pull(est))` and `r max(plsr2%>%filter(task == "Gaze following")%>%pull(est))`. The correlations between latent states for the different time points were generally high, pointing to stable individual differences (Supplementary Figure \@ref(fig:lsplot2)).

In the LST model, consistency was estimated to be 0.769, that is around 77% of true inter-individual differences are attributable to stable differences between individuals. Approximately 23% of inter-individual differences were due to variance in time point specific deviations from the stable trait. Reliability was good with an estimate of 0.77. In sum, gaze following in Phase 2 was stable over time with systematic and stable differences between individuals (Supplementary Figure \@ref(fig:perfplot)).

#### Quantity discrimination

As in phase 1, the lowest three (out of seven possible) categories (0, 1 and 2 correctly solved trials per test half) had to be collapsed due to sparsity. Thresholds were set equal across all time points.

Like for gaze following, none of the latent state means differed from zero, except for time point 14. Reliability estimates were substantially lower compared to the other tasks (Supplementary Figure \@ref(fig:lseplot2)). Correlations between time points were generally high, but somewhat lower compared to gaze following or direct causal inference.

In the LST model, the consistency coefficient was estimated to be 0.939, that is around 94% of true inter-individual differences was attributable to stable differences between individuals. Only 6% of inter-individual differences were due to variance in time-point specific deviations from the stable trait. With an estimate of 0.436, reliability was once again lower compared to the other tasks.

Taken together, quantity judgments were robust over time on the task level. Task-level performance was clearly different from chance (Supplementary Figure \@ref(fig:perfplot)). Performance was also stable on an individual level, with the constraint that the reliability of measurement was lower compared to the other tasks.

#### Delay of gratification

Thresholds could not be set equal for test half 1 at time point 2, 9, 10, 11, and 14 as well as test half 2 at time point 6 and 7 due to a different number of observed categories for the respective test half and time point combination. Latent means can still be compared across time.

Three of the latent state means were significantly different from zero (time point 4, 5 and 8). However, there was no clear temporal pattern in that the latent means steadily de- or increased (Supplementary Figure \@ref(fig:lseplot2)). Reliability was very high at all time points. Latent state correlations across the different time points were generally high, with time point 4 being a notable exception with lower correlations with time points further away (Supplementary Figure \@ref(fig:lsplot2)).

In the LST model, consistency was estimated to be around 0.772, that is around 77% of true inter-individual differences are attributable to stable differences between individuals. Approximately 23% of inter-individual differences were due to variance in time point specific deviations from the stable trait. Reliability was high with an estimate of 0.891.

In sum, delay of gratification showed some variation in task-level performance. Differences between individuals were relatively stable over time, though slightly less so compared to other tasks (Supplementary Figure \@ref(fig:perfplot)).

### Comparison between phases

For the comparison, we will focus on the four tasks that were included in both phases: direct causal inference, inference by exclusion, gaze following and quantity.

For the direct causal inference task, the raw performance in Supplementary Figure \@ref(fig:perfplot) shows no marked difference between the two phases. Similarly, we see no systematic difference between the two phases when looking at the latent state means and threshold parameters estimated by the LS model. This suggests robust task-level performance across the two phases. The LST model estimates for consistency, occasion specificity and reliability were also very similar for the two phases (Supplementary Figure \@ref(fig:lstdifplot)), which indicates that individual differences were structured similarly in the two phases.

For inference by exclusion, we saw an increase in performance towards the end of Phase 2 (Supplementary Figure \@ref(fig:perfplot)), which was also reflected in the latent state means. As noted above, a relatively quick change in performance by some individuals was most likely responsible for this task-level increase. As a consequence, for the LST model, we had to split Phase 2 into two parts. Nevertheless, the LST model estimates for Phase 1 and both parts of Phase 2 were very similar.

The gaze following task showed notable differences between the two phases. The initial decline in gaze following in the beginning of Phase 1 did not repeat itself in Phase 2. Performance in Phase 2 seemed to pick up where it left off at the end of Phase 1 (Supplementary Figure \@ref(fig:perfplot)). The LS model mean estimates for the different time points follow a similar pattern. Despite this difference in task-level performance, the near-identical LST model estimates for consistency and occasion specificity showed that individual differences were structured in a similar way across the two phases (Supplementary Figure \@ref(fig:lstdifplot)).

```{r}
lstdif <- bind_rows(
bind_rows(
  lstc$parameters$unstandardized%>%mutate(task = "causality"),
  lsti$parameters$unstandardized%>%mutate(task = "inference"),
  lstq$parameters$unstandardized%>%mutate(task = "quantity"),
  lstg$parameters$unstandardized%>%mutate(task = "gaze_following")
  )%>%
  filter(paramHeader== "New.Additional.Parameters",
         !grepl("DIF",param))%>%
  mutate(param = recode(param, CON1 = "Consistency", OCC1 = "Occasion specificity", REL1 = "Reliability"))%>%mutate(phase = "Phase 1"),
bind_rows(
  lstc2$parameters$unstandardized%>%mutate(task = "causality"),
  #lsti2$parameters$unstandardized%>%mutate(task = "inference"),
  lstq2$parameters$unstandardized%>%mutate(task = "quantity"),
  lstg2$parameters$unstandardized%>%mutate(task = "gaze_following")
  )%>%
  filter(paramHeader== "New.Additional.Parameters",
         !grepl("DIF",param))%>%
  mutate(param = recode(param, CON1 = "Consistency", OCC1 = "Occasion specificity", REL1 = "Reliability"))%>%mutate(phase = "Phase 2")
)%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))%>%
  mutate(part = "Part 1")%>%
  bind_rows(lsti2p2$parameters$unstandardized%>%mutate(task = "inference", phase = "Phase 2")%>%
  filter(paramHeader== "New.Additional.Parameters",
         !grepl("DIF",param))%>%
  mutate(part = ifelse(grepl("1", param), "Part 1", "Part 2"),
         param = recode(param, CON1 = "Consistency", OCC1 = "Occasion specificity", REL1 = "Reliability",CON2 = "Consistency", OCC2 = "Occasion specificity", REL2 = "Reliability"),
         task = "Inference by exclusion"))%>%
  mutate(task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination", "Delay of gratification")))

plstdif <- ggplot(lstdif, aes(x = param, y = est, col = phase, pch = part))+
  geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci), position = position_dodge(width = .9))+
  facet_grid(~task)+
  theme_few()+
  labs(x = "", y = "Model estiamte")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(legend.position = "right")+
  scale_color_discrete(name = "Task")+
  scale_shape(guide = F)
  


```

```{r lstdifplot, fig.height = 3, fig.width = 10, fig.cap = "LST model estimates for Phase 1 and Phase 2. Points show mean of the posterior distribution with 95\\% CrI based on data from N = 43 participants. In Phase 2, inference by exclusion has two estimates, one for each part (see text for details).", out.width="100%"}
plstdif
```

Raw performance in the quantity task did not show a markedly different pattern in the two phases (Supplementary Figure \@ref(fig:perfplot)). This was once again also reflected in the latent state means estimated by the LS model and suggests stable task-level performance across the two phases. The three LST model estimates for consistency, occasion specificity and reliability were also very similar for the two phases, which indicates that individual differences were measured and structured in a similar way in the two phases (Supplementary Figure \@ref(fig:lstdifplot)).

## Relations between tasks {#relations-between-tasks}

To analyse relations between different tasks (constructs), we estimated separate LST models, each modeling the relation between two tasks. In these combined models, the sub-models for each task were equivalent to the LST models described above. For ease of model specification, the LST models were estimated as multilevel models. These models are equivalent to the LST models for single tasks under the assumption of strict factorial invariance. Supplementary Figure \@ref(fig:relgraph) visualizes the model for two tasks.

```{r relgraph, engine='tikz', fig.cap="Latent State-Trait models for two tasks with correlations between traits and states for two indicators and six measurement time points.", out.width="80%", fig.align='center'}

\usetikzlibrary{arrows} 
\usetikzlibrary{positioning} 
\usetikzlibrary{shapes} 
\usetikzlibrary{fit} 
\usetikzlibrary{backgrounds} 
\usetikzlibrary{calc}

\begin{tikzpicture}
 [manifest/.style={rectangle,draw=black!80,semithick,minimum width=1.5cm,inner sep=
4pt,text centered},
        latent/.style={ellipse,draw=black!80,thick,inner sep=2,text centered},
        on/.style={->,>=stealth',semithick},
        from/.style={<-,>=stealth',semithick},
        with1/.style={<->,>=stealth',semithick,bend left=30},
        with2/.style={<->,>=stealth',semithick,bend right=30},
        with3/.style={<->,>=stealth',semithick,bend left=50},]


%%%%%%%%%%%%% Konstrukt 1
   
% Latent Variables %
 \begin{scope}[node distance=1.5]
                \node[latent] (o1) at (0,0) {$\zeta_{21}$};
                \node[latent] (o2) [below=of o1] {$\zeta_{22}$};
                \node[latent] (o3) [below=of o2] {$\zeta_{23}$};
                \node[latent] (o4) [below=of o3] {$\zeta_{24}$};
                \node[latent] (o5) [below=of o4] {$\zeta_{25}$};
                \node[latent] (o6) [below=of o5] {$\zeta_{26}$};
\end{scope}
                     
% Trait % 
\node[latent,node distance=7] (t) [right=of  o4]  {$T_{2}$};
                                             	                        
% Manifest % 
 \foreach \a in {1,...,6} {\node (y1\a) [right = 2 of o\a] (yhelp\a) {};}        
 \foreach \b in {1,...,6} {\node[manifest] [above = .05 of yhelp\b] (y1\b) {$Y^*_{12\b}$}
 	edge [from] node[above] {1} (o\b);}
 \foreach \c in {1,...,6} {\node[manifest] [below = .05 of yhelp\c] (y2\c) {$Y^*_{22\c}$}
 	edge [from] node[below] {$1$} (o\c);} 

    
% Pfeile %
\foreach \a in {1,...,6}
	\path (y1\a.0) edge [from] (t);
\foreach \a in {1,...,6}	
	\path (y2\a.0) edge [from] (t);
    
  % Fehler %
\foreach \a in {1,...,5} {\node (e1\a) [below right = .3 of y1\a] {}
	edge [on] (y1\a.south east);}
\foreach \b in {1,...,5} {\node (e2\b) [below right = .3 of y2\b] {}
	edge [on] (y2\b.south east);}

\node (e16) [below right = .3 of y16] {$\epsilon_{126}$}
	edge [on] (y16.south east);
\node (e26) [below right = .3 of y26] {$\epsilon_{226}$}
	edge [on] (y26.south east);
	
	
  
  %%%%%%%%%%%%% Konstrukt 2
   
% Latent Variables %
 \begin{scope}[node distance=1.5]
                \node[latent] (o11) [left= 2 of o1] {$\zeta_{11}$};
                \node[latent] (o21) [below=of o11] {$\zeta_{12}$};
                \node[latent] (o31) [below=of o21] {$\zeta_{13}$};
                \node[latent] (o41) [below=of o31] {$\zeta_{14}$};
                \node[latent] (o51) [below=of o41] {$\zeta_{15}$};
                \node[latent] (o61) [below=of o51] {$\zeta_{16}$};
\end{scope}

% Manifest % 
 \foreach \a in {1,...,6} {\node (y11\a) [left = 2 of o\a1] (yhelp\a1) {};}        
 \foreach \b in {1,...,6} {\node[manifest] [above = .05 of yhelp\b1] (y11\b) {$Y^*_{11\b}$}
 	edge [from] node[above] {1} (o\b1);}
 \foreach \c in {1,...,6} {\node[manifest] [below = .05 of yhelp\c1] (y21\c) {$Y^*_{21\c}$}
 	edge [from] node[below] {$1$} (o\c1);} 

%Trait%
\node[latent,node distance=7] (t1) [left=of  o41]  {$T_{1}$};

% Pfeile %
\foreach \a in {1,...,6}
	\path (y11\a.180) edge [from] (t1);
\foreach \a in {1,...,6}	
	\path (y21\a.180) edge [from] (t1);


  % Fehler %
\foreach \a in {1,...,5} {\node (e11\a) [below left = .3 of y11\a] {}
	edge [on] (y11\a.south west);}
\foreach \b in {1,...,5} {\node (e21\b) [below left = .3 of y21\b] {}
	edge [on] (y21\b.south west);}

\node (e16) [below left = .3 of y116] {$\epsilon_{116}$}
	edge [on] (y116.south west);
\node (e26) [below left = .3 of y216] {$\epsilon_{216}$}
	edge [on] (y216.south west);
	

%%%%%%%%%%%%% Korrelationen
\foreach \a in {1,...,6} {\draw[<->,>=stealth ,semithick,] (o\a) to [with1] (o\a1);}

\coordinate [below = 6cm of t1] (fit above) {};
\coordinate [below= 6cm of t] (fit right) {};

\draw[<-,>=stealth,semithick] (t1.south) -- (fit above);
\draw[semithick] (fit above) -| (fit right);   
\draw[->,>=stealth,semithick] (fit right) to (t.south);  
   
\end{tikzpicture}

```

Detailed information on the parameter estimates obtained in LST models for each separate task is provided above. Here we report the results with a focus on the latent correlations only. The parameters of interest were correlations between a) the latent traits, indicating associations between stable cognitive abilities as estimated by the different tasks, and b) correlations between state residual variables belonging to the same measurement time point, as an indicator of time-specific associations between latent abilities across the two tasks, above and beyond stable trait differences.

Simulation studies suggested that LST models in which latent correlations between time-specific state residual variables were estimated to be time-point specific (i.e. covariances and variances of state residual variables can freely vary across time) did not show good estimation performance under the given conditions (sample size, ordinal indicator variables, etc.). Therefore, we chose a model with fixed correlations between state residual variables across time. That is, a model in which we assumed that associations between latent time-specific cognitive abilities across two different tasks within each time point are equal at all time points. We think that this assumption is reasonable in the present context. As a consequence, just one correlation between latent state residual variables is estimated for each model. The corresponding model showed good estimation performance under the given sample sizes in a simulation study.

For details on MCMC estimation see section on [estimation](#estimation) above. Because the multi-construct models were considerably more complex (i.e. had more parameters), we increased the minimum number of iterations per Markov chain to 20,000 (with a thinning of 10, that is, 200,000 iterations per chain).

### Phase 1

```{r, include=F}
# latent state models
lstcg <- readModels("../../models and documentation Jana/Application/two tasks models/test_apes_data_LST_cau_gaze.out")
lstci <- readModels("../../models and documentation Jana/Application/two tasks models/test_apes_data_LST_cau_inf.out")
lstcq <- readModels("../../models and documentation Jana/Application/two tasks models/test_apes_data_LST_cau_quant_indspec.out")
lstig <- readModels("../../models and documentation Jana/Application/two tasks models/test_apes_data_LST_inf_gaze.out")
lstiq <- readModels("../../models and documentation Jana/Application/two tasks models/test_apes_data_LST_inf_quant.out")
lstqg <- readModels("../../models and documentation Jana/Application/two tasks models/test_apes_data_LST_quant_gaze.out")
```

```{r}
rtt <- tibble(
  Task1 = c("causality", "", "", "inference", "", "quantity"),
  Task2 = c("gaze_following","inference","quantity", "gaze_following","quantity","gaze_following"),
  PPP = c(lstcg$summaries$PostPred_PValue,
          lstci$summaries$PostPred_PValue,
          lstcq$summaries$PostPred_PValue,
          lstig$summaries$PostPred_PValue,
          lstiq$summaries$PostPred_PValue,
          lstqg$summaries$PostPred_PValue),
  `Chi 95% CI` = c(
    paste(lstcg$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstcg$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstci$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstci$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstcq$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstcq$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstig$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstig$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstiq$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstiq$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstqg$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstqg$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; ")))%>%
  mutate(Task1 = recode(Task1,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  Task2 = recode(Task2,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))
```

```{r relt}
kable(rtt, align = c("l", "l", "c", "c"), caption = "Model fit indices for multi-construct models Phase 1", booktabs=TRUE)%>%
kable_classic(full_width = F)%>%
      footnote(c("PPP = Posterior predictive p-value. Cut-off values (two-tailed): 0.025 and 0.975", "Chi 95% CI = 95%CI of difference between predicted and observed chi-square values"))
```

Model fit indices are shown in Supplementary Table \@ref(tab:relt). Due to a low PPP value, the model for direct causal inference and quantity discrimination was modified such that for each task, test-half specific trait factors were estimated on the between-level. The correlations between the two tasks are therefore also reported as test-half specific trait correlations.

The only correlations for which the 95% CI did not include zero were the state residual correlation between direct causal inference and inference by exclusion ($r_{s_c,s_i}$ = `r lstci$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(est)`, 95% CI = [`r lstci$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(lower_2.5ci)`; `r lstci$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(upper_2.5ci)`]) and the trait correlation between inference by exclusion and quantity discrimination ($r_{t_i,t_q}$ = `r lstiq$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(est)`, 95% CI = [`r lstiq$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(lower_2.5ci)`; `r lstiq$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(upper_2.5ci)`]).

The negative state correlations between direct causal inference and inference by exclusion may be explained by the way the two tasks were presented. Remember that direct causal inference and inference by exclusion trials used the same setup and were intermixed. A negative correlation suggests that higher (residual) performance in one task was associated with lower performance in the other task. Responding correctly in the two tasks required opposite choice behaviors. That is, in direct causal inference, the ape had to pick the cup the experimenter shook to be correct. In inference, it was the unshaken cup. Such a negative correlation arises when sometimes participants respond in the same way (e.g. pick the shaken cup) across tasks. Note, however, that if this were a stable strategy which individuals would consistently use, we would have seen a negative correlation between the trait estimates. The best explanation is thus that there are short periods of inattentiveness during which (some) participants confused the two tasks.

The trait correlation between inference by exclusion and quantity discrimination was positive, suggesting that individuals with better quantity judgment abilities also have better inferential abilities.

One (out of four) of the test-half specific trait correlations between direct causal inference and quantity discrimination was also different from zero ($r_{t_{c_{h2}},t_{q_{h1}}}$ = `r lstcq$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ1")%>%pull(est)`, 95% CI = [`r lstcq$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ1")%>%pull(lower_2.5ci)`; `r lstcq$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ1")%>%pull(upper_2.5ci)`]). We do not consider this result to be substantial evidence for a substantive association between the trait estimates in the two tasks and therefore do not interpret it any further. Supplementary Figure \@ref(fig:mtmplot) shows all correlations between the different tasks.

```{r}
mtmcor <- bind_rows(
lstcg$parameters$stdyx.standardized,
lstci$parameters$stdyx.standardized,
lstcq$parameters$stdyx.standardized,
lstig$parameters$stdyx.standardized,
lstiq$parameters$stdyx.standardized,
lstqg$parameters$stdyx.standardized,
)%>%
  filter(grepl(".WITH", paramHeader))%>%
  mutate(paramHeader = str_replace(paramHeader, "\\.WITH",""),
         type = ifelse(grepl("S",paramHeader),"State residual","Trait"),
         task1 = str_remove_all(paramHeader,"[ST]"),
         task2 = str_remove_all(param,"[ST]"))%>%
  filter(!grepl("1", task1),!grepl("2", task1))%>%
  mutate(task1 = recode(task1, G = "gaze_following", I = "inference", C = "causality", Q = "quantity"),
         task2 = recode(task2, G = "gaze_following", I = "inference", C = "causality", Q = "quantity"),
         label = paste0(round(est,2)," \n [", round(lower_2.5ci,2)," ; ", round(upper_2.5ci,2),"]"))%>%
  mutate(task1 = recode(task1,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task2 = recode(task2,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))

pmtmcor <- mtmcor%>%
  ggplot(aes(y = task1, x = task2, fill = est, label = label))+
    geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "#FFE066", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Correlation")+
  facet_grid(~type)+
  geom_text(size = 2.8, fontface = ifelse(mtmcor$sig == T, 2, 1))+
  theme_few()+
  scale_x_discrete(guide = guide_axis(n.dodge = 2),limits = c("Causal inference", "Quantity discrimination","Gaze following"))+
  scale_y_discrete(limits = c( "Inference by exclusion","Gaze following", "Quantity discrimination"))+
  theme(legend.position = c(0.92,0.75), legend.direction = "vertical", legend.title = element_blank(), legend.key = element_blank())
```

```{r mtmplot, fig.height=4, fig.width=8, fig.cap = "Phase 1: correlations between latent traits and latent state residual variables, respectively, of different tasks. Bold correlations are different from zero as judged by the 95\\% CI. The trait correlations between quantity discrimination and direct causal inference are not displayed, see main text for details. See main text for details.", out.width="100%"}
pmtmcor
```

### Phase 2

```{r, include=F}
# latent state models
lstcg2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_cau_gaze.out")
lstci2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_cau_inf.out")
lstci2p1 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_cau_inf_phase1.out")
lstci2p2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_cau_inf_phase2.out")
lstcq2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_cau_quant_indspec.out")
lstcd2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_cau_delay.out")

lstig2p1 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_gaze_phase1.out")
lstig2p2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_gaze_phase2.out")
lstiq2p1 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_quant_phase1.out")
lstiq2p2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_quant_phase2.out")
lstid2p1 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_delay_phase1.out")
lstid2p2<- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_delay_phase2.out")

lstig2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_gaze.out")
lstiq2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_quant.out")
lstid2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_inf_delay.out")

lstqg2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_quant_gaze.out")
lstqd2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_quant_delay.out")

lstgd2 <- readModels("../../models and documentation Jana/Application/Testphase 2/two construct models/test_apes_data_LST_gaze_delay.out")

```

```{r}
rtt2 <- tibble(
  Task1 = c("causality", "", "", "","", "inference", "","", "","","", "quantity","","gaze_following"),
  Task2 = c("gaze_following","inference","","quantity","delay_of_gratification", "gaze_following", "","quantity","","delay_of_gratification","","gaze_following","delay_of_gratification","delay_of_gratification"),
  Part = c("","Part 1","Part 2","","","Part 1","Part 2","Part 1","Part 2","Part 1","Part 2","","",""),
  PPP = c(lstcg2$summaries$PostPred_PValue,
          lstci2p1$summaries$PostPred_PValue,
          lstci2p2$summaries$PostPred_PValue,
          lstcq2$summaries$PostPred_PValue,
          lstcd2$summaries$PostPred_PValue,
          lstig2p1$summaries$PostPred_PValue,
          lstig2p2$summaries$PostPred_PValue,
          lstiq2p1$summaries$PostPred_PValue,
          lstiq2p2$summaries$PostPred_PValue,
          lstid2p1$summaries$PostPred_PValue,
          lstid2p2$summaries$PostPred_PValue,
          lstqg2$summaries$PostPred_PValue,
          lstqd2$summaries$PostPred_PValue,
          lstgd2$summaries$PostPred_PValue),
  `Chi 95% CI` = c(
    paste(lstcg2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstcg2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    
    paste(lstci2p1$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstci2p1$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
        paste(lstci2p2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstci2p2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    
    paste(lstcq2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstcq2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    
    paste(lstcd2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstcd2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    
    paste(lstig2p1$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstig2p1$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
      paste(lstig2p2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstig2p2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    
    paste(lstiq2p1$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstiq2p1$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
      paste(lstiq2p2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstiq2p2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    
    paste(lstid2p1$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstid2p1$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
        paste(lstid2p2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstid2p2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
        
    paste(lstqg2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstqg2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(lstqd2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstqd2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    
    paste(lstgd2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2), lstgd2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; ")
    ))%>%
  mutate(Task1 = recode(Task1,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  Task2 = recode(Task2,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))
```

```{r}
mtmcor2 <- bind_rows(
lstcg2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstci2p1$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstci2p2$parameters$stdyx.standardized%>%mutate(part = "Part 2"),
lstcq2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstcd2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstig2p1$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstig2p2$parameters$stdyx.standardized%>%mutate(part = "Part 2"),
lstiq2p1$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstiq2p2$parameters$stdyx.standardized%>%mutate(part = "Part 2"),
lstid2p1$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstid2p2$parameters$stdyx.standardized%>%mutate(part = "Part 2"),
lstqg2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstqd2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstgd2$parameters$stdyx.standardized%>%mutate(part = "Part 1")
)%>%
  filter(grepl(".WITH", paramHeader))%>%
  mutate(paramHeader = str_replace(paramHeader, "\\.WITH",""),
         type = ifelse(grepl("S",paramHeader),"State residual","Trait"),
         task1 = str_remove_all(paramHeader,"[ST]"),
         task2 = str_remove_all(param,"[ST]"))%>%
  filter(!grepl("1", task1),!grepl("2", task1))%>%
  mutate(task1 = recode(task1, G = "Gaze following", I = "Inference by exclusion", C = "Causal inference", Q = "Quantity discrimination", D = "Delay of grat."),
         task2 = recode(task2, G = "Gaze following", I = "Inference by exclusion", C = "Causal inference", Q = "Quantity discrimination", D = "Delay of grat."),
         )
  
lstlabel <- mtmcor2%>%
  mutate(label = paste0(round(est,2)," \n [", round(lower_2.5ci,2)," ; ", round(upper_2.5ci,2),"]"))%>%
  select(task1,task2,type,part, label)%>%
  pivot_wider(names_from = part, values_from = label)%>%
  mutate(label = ifelse(!is.na(`Part 2`), paste0(`Part 1`,"\n",`Part 2`),`Part 1`))

mtmcor2 <- mtmcor2%>%
  left_join(lstlabel)

pmtmcor2 <- mtmcor2%>%
  ggplot(aes(y = task1, x = task2, fill = est, label = label))+
    geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "#FFE066", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Correlation")+
  facet_grid(~type)+
  geom_text(size = 2.2, fontface = ifelse(mtmcor2$sig == T, 2, 1))+
  theme_few()+
scale_x_discrete(guide = guide_axis(n.dodge = 2),limits = c("Causal inference", "Quantity discrimination","Gaze following", "Delay of grat."))+
  scale_y_discrete(limits = c( "Inference by exclusion","Delay of grat.","Gaze following", "Quantity discrimination"))+
  theme(legend.position = c(0.92,0.75), legend.direction = "vertical", legend.title = element_blank(), legend.key = element_blank())
```

```{r relt2}
  kable(rtt2, align = c("l", "l", "c", "c"), caption = "Model fit indices for multi-construct models Phase 2", booktabs=TRUE)%>%
kable_classic(full_width = F)%>%
      footnote(c("PPP = Posterior predictive p-value. Cut-off values (two-tailed): 0.025 and 0.975", "Chi 95% CI = 95%CI of difference between predicted and observed chi-square values", "Part = separate models for the two parts of the data (see main text for details)"))
```

Model fit indices are shown in Supplementary Table \@ref(tab:relt2). Like in Phase 1, due to a low PPP value, the model for direct causal inference and quantity was modified such that for each task, test-half specific trait factors were estimated on the between-level. The correlations between the two tasks are therefore also reported as test-half specific trait correlations.

As noted above, we had to fit a 2-part LST model to the data of the inference by exclusion task. We retained this adjustment and for all models involving two tasks, we modeled the correlations between tasks separately for the two parts. Thus, there are two correlations (one for part 1 and one for part 2) for each case involving inference by exclusion.

For the state residuals, the correlation between inference by exclusion and delay of gratification for the first part of the Phase 2 was estimated to be different from zero ($r_{s_{i_1},s_{d_1}}$ = `r lstid2p1$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(est)`, 95% CI = [`r lstid2p1$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(lower_2.5ci)`; `r lstid2p1$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(upper_2.5ci)`]). Given that for the second part of this pairing the correlation was effectively zero ($r_{s_{i_2},s_{d_2}}$ = `r lstid2p2$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(est)`, 95% CI = [`r lstid2p2$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(lower_2.5ci)`; `r lstid2p2$parameters$stdyx.standardized%>%filter(paramHeader == "SI.WITH")%>%pull(upper_2.5ci)`]), we do not take this to be strong evidence for a systematic relation between the state residuals.

Five of nine task combinations showed evidence for a substantial trait correlation. These included quantity discrimination and delay of gratification ($r_{t_d,t_q}$ = `r lstqd2$parameters$stdyx.standardized%>%filter(paramHeader == "TD.WITH")%>%pull(est)`, 95% CI = [`r lstqd2$parameters$stdyx.standardized%>%filter(paramHeader == "TD.WITH")%>%pull(lower_2.5ci)`; `r lstqd2$parameters$stdyx.standardized%>%filter(paramHeader == "TD.WITH")%>%pull(upper_2.5ci)`]) as well as quantity discrimination and gaze following ($r_{t_g,t_q}$ = `r lstqg2$parameters$stdyx.standardized%>%filter(paramHeader == "TG.WITH")%>%pull(est)`, 95% CI = [`r lstqg2$parameters$stdyx.standardized%>%filter(paramHeader == "TG.WITH")%>%pull(lower_2.5ci)`; `r lstqg2$parameters$stdyx.standardized%>%filter(paramHeader == "TG.WITH")%>%pull(upper_2.5ci)`]). The remaining three included the inference by exclusion task and thus had two coefficients per combination: inference by exclusion and direct causal inference (Part 1: $r_{t_{i_1},t_{q_1}}$ = `r lstci2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(est)`, 95% CI = [`r lstci2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(lower_2.5ci)`; `r lstci2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(upper_2.5ci)`]; Part 2: $r_{t_{i_2},t_{q_2}}$ = `r lstci2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(est)`, 95% CI = [`r lstci2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(lower_2.5ci)`; `r lstci2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(upper_2.5ci)`]) as well as inference by exclusion and delay of gratification (Part 1: $r_{t_{i_1},t_{d_1}}$ = `r lstid2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(est)`, 95% CI = [`r lstid2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(lower_2.5ci)`; `r lstid2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(upper_2.5ci)`]; Part 2: $r_{t_{i_2},t_{d_2}}$ = `r lstid2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(est)`, 95% CI = [`r lstid2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(lower_2.5ci)`; `r lstid2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(upper_2.5ci)`]). For inference by exclusion and quantity discrimination, only the correlation for Part 1 was different from zero, the one for Part 2, however, was also largely positive (Part 1: $r_{t_{i_1},t_{q_1}}$ = `r lstiq2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(est)`, 95% CI = [`r lstiq2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(lower_2.5ci)`; `r lstiq2p1$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(upper_2.5ci)`]; Part 2: $r_{t_{i_2},t_{q_2}}$ = `r lstiq2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(est)`, 95% CI = [`r lstiq2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(lower_2.5ci)`; `r lstiq2p2$parameters$stdyx.standardized%>%filter(paramHeader == "TI.WITH")%>%pull(upper_2.5ci)`]).

Two (out of four) of the test-half specific trait correlations between direct causal inference and quantity discrimination were also different from zero ($r_{t_{c_{h1}},t_{q_{h2}}}$ = `r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC1.WITH", param == "TQ2")%>%pull(est)`, 95% CI = [`r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC1.WITH", param == "TQ2")%>%pull(lower_2.5ci)`; `r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC1.WITH", param == "TQ2")%>%pull(upper_2.5ci)`]; $r_{t_{c_{h2}},t_{q_{h2}}}$ = `r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ2")%>%pull(est)`, 95% CI = [`r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ2")%>%pull(lower_2.5ci)`; `r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ2")%>%pull(upper_2.5ci)`]). Given that a third correlation was also of similar magnitude ($r_{t_{c_{h2}},t_{q_{h1}}}$ = `r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ1")%>%pull(est)`, 95% CI = [`r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ1")%>%pull(lower_2.5ci)`; `r lstcq2$parameters$stdyx.standardized%>%filter(paramHeader == "TC2.WITH", param == "TQ1")%>%pull(upper_2.5ci)`]), we consider this to be at least suggestive evidence that individuals with higher quantitative abilities were also better at making direct causal inferences. Supplementary Figure \@ref(fig:mtmplot2) shows all correlations between the different tasks.

```{r mtmplot2, fig.height=4, fig.width=8, fig.cap = "Phase 2: correlations between latent traits and latent state residual variables, respectively, of different tasks. Bold correlations are different from zero as judged by the 95\\% CI.", out.width="100%"}
pmtmcor2
```

### Comparison between phases

The most notable difference between the two phases was that we saw more substantial trait correlations in Phase 2 compared to Phase 1. This was expected given that we had one additional task in Phase 2 and thus four more combined models. The only significant trait correlation from Phase 1 also turned out to be significant in Phase 2 (quantity discrimination and inference by exclusion). For the tasks that were part of both phases, correlations were numerically similar (Supplementary Figure \@ref(fig:mtmplotc)).

These results suggest low to moderate commonalities between the traits -- with gaze following being an exception (see Supplementary Figure \@ref(fig:mtmplotc)). However, the sample size we studied here is still comparatively small for individual differences research. Larger samples are needed to corroborate these findings.

The significant *negative* state residual correlation between direct causal inference and inference by exclusion found in Phase 1 was not present in Phase 2. This suggests a de-coupling between the two tasks in that apes were less likely to confuse them in Phase 2. This interpretation is also supported by the increase in task-level performance for inference by exclusion and an increase in the trait correlation between the two tasks.

```{r}
lstmcor <- bind_rows(
  bind_rows(
lstcg2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstci2p1$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstci2p2$parameters$stdyx.standardized%>%mutate(part = "Part 2"),
lstcq2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstcd2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstig2p1$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstig2p2$parameters$stdyx.standardized%>%mutate(part = "Part 2"),
lstiq2p1$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstiq2p2$parameters$stdyx.standardized%>%mutate(part = "Part 2"),
lstid2p1$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstid2p2$parameters$stdyx.standardized%>%mutate(part = "Part 2"),
lstqg2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstqd2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstgd2$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
)%>%mutate(phase = "Phase 2"),

bind_rows(
lstcg$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstci$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstcq$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstig$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstiq$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
lstqg$parameters$stdyx.standardized%>%mutate(part = "Part 1"),
)%>%mutate(phase = "Phase 1")
)%>%
  filter(grepl(".WITH", paramHeader))%>%
  mutate(paramHeader = str_replace(paramHeader, "\\.WITH",""),
         type = ifelse(grepl("S",paramHeader),"State residual","Trait"),
         task1 = str_remove_all(paramHeader,"[ST]"),
         task2 = str_remove_all(param,"[ST]"))%>%
  filter(!grepl("1", task1),!grepl("2", task1))%>%
  mutate(task1 = recode(task1, G = "Gaze following", I = "Inference by exclusion", C = "Causal inference", Q = "Quantity discrimination", D = "Delay of grat."),
         task2 = recode(task2, G = "Gaze following", I = "Inference by exclusion", C = "Causal inference", Q = "Quantity discrimination", D = "Delay of grat."),
         )%>%
  filter(type == "Trait")

lstlabel <- lstmcor%>%
  mutate(label = paste0(round(est,2)," \n [", round(lower_2.5ci,2)," ; ", round(upper_2.5ci,2),"]"))%>%
  select(task1,task2,phase,part, label)%>%
  pivot_wider(names_from = part, values_from = label)%>%
  mutate(label = ifelse(phase == "Phase 2" & !is.na(`Part 2`), paste0(`Part 1`,"\n",`Part 2`),`Part 1`))

plstmcor <- lstmcor%>%
  left_join(lstlabel)

pmtmcorc <- plstmcor%>%
  ggplot(aes(y = task1, x = task2, label = label))+
    geom_tile(color = "white", aes(fill = est))+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "#FFE066", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Correlation")+
  facet_grid(~phase)+
  geom_text(size = 2.5, fontface = ifelse(plstmcor$sig == T, 2, 1))+
  theme_few()+
  scale_x_discrete(guide = guide_axis(n.dodge = 2),limits = c("Causal inference", "Quantity discrimination","Gaze following", "Delay of grat."))+
  scale_y_discrete(limits = c( "Inference by exclusion","Delay of grat.","Gaze following", "Quantity discrimination"))+
  theme(legend.text=element_text(size=7),legend.key.size = unit(0.5,"cm"), 
        legend.position = c(0.92,0.75), 
        legend.direction = "vertical", legend.title = element_blank())
```

```{r mtmplotc, fig.height=4, fig.width=8, fig.cap = "Differences between phases in correlations between latent traits and latent state residual variables for the different tasks.", out.width="100%"}
pmtmcorc
```

## Predictability {#predictability}

The output of the projection predictive inference models is a ranking of the different predictors with respect to how much they improve a model's fit. Predictors ranked first improve the fit the most, while later predictors yield smaller improvements (if any). The selection of "relevant" predictors is based on plotting the loss statistics and looking for a point at which it levels off. As such, the selection is to some extent arbitrary. The ranking, however, is not. When we compare the results from the two phases, we not just look at which subset of predictors is selected, but also at the overall ranking.

### Phase 1

```{r}
ncores <- parallel::detectCores()
```

```{r, include = FALSE}
# df_trials <- df_trials %>% 
#   select(-c(time_waited, birth_date, comment, experimenter, pick, condition, heat))
# sum_resp <- function(x, ...) {
#   # helper function: sum over `correct response` variable (code)
#   to_return = tibble(cogn = sum(x$code))
# }
# 
# resp_sum <- df_trials %>%
#   # contains summed code variable for [task, time point, session, subject]
#   group_by(time_point, session, subject, task) %>%
#   group_modify(sum_resp)
# 
# df_tmp <- df_trials %>%
#   # helper for merging
#   select(-c(date, trial_session, trial_time_point, code)) %>%
#   unique(by = c("time_point", "session", "subject"))
# 
# df_trials_final <- inner_join(df_tmp, resp_sum)
# 
# df_trials_final <- df_trials_final %>% 
#   mutate(across(c(sick_severity, 
#                   le_mean, 
#                   dist_mean, 
#                   time_outdoors, 
#                   age, 
#                   time_in_leipzig), 
#                 ~scale(., center = T, scale = F))) %>% 
#   mutate(across(c(session, 
#                   subject, 
#                   group, 
#                   sex,
#                   test_day, 
#                   le_present, 
#                   dist_present,
#                   rearing,
#                   observer), 
#                 as_factor)) %>% 
#   mutate(observer = fct_relevel(observer, "no")) %>% 
#   mutate(rearing = fct_recode(rearing, "hand" = "unknown")) %>% 
#   # create new observer variable due to different measurements of observer between phases
#   mutate(observer_mod = case_when(
#     observer == "yes" ~ "yes",
#     observer == "no" ~ "no",
#     observer != "no" & observer != "yes" & observer != "NA" ~ "yes",
#     TRUE ~ "no"
#   ), observer_mod =  as_factor(observer_mod))
# 
# grp_size <- tibble(
#   # number of apes for each species
#   a_chimp = 20,
#   b_chimp = 6,
#   bonobo = 12,
#   gorilla = 6,
#   orangutan = 6
# )
# 
# df_trials_final <- df_trials_final %>%
#   # relative rank of ape within species (varies between time points)
#   group_by(group, time_point) %>%
#   mutate(
#     rel_rank = case_when(
#       group == "a_chimp" ~ percent_rank(grp_size$a_chimp:1)[rank],
#       group == "b_chimp" ~ percent_rank(grp_size$b_chimp:1)[rank],
#       group == "bonobo" ~ percent_rank(grp_size$bonobo:1)[rank],
#       group == "gorilla" ~ percent_rank(grp_size$gorilla:1)[rank],
#       group == "orangutan" ~ percent_rank(grp_size$orangutan:1)[rank]
#     )
#   ) %>%
#   ungroup()
```

```{r, include = F}
# t_cau <- filter(df_trials_final, task == "causality")
# t_inf <- filter(df_trials_final, task == "inference")
# t_quant <- filter(df_trials_final, task == "quantity")
# t_gaze <- filter(df_trials_final, task == "gaze_following")
# t_grat <- filter(df_trials_final, task == "delay_of_gratification")
```

```{r, include = F}
# t_gaze <- t_gaze %>%
#   # create dummy variable indicating if in session 1 or 2
#   group_by(time_point, session) %>% 
#   mutate(tp_mod = cur_group_id()) %>%
#   ungroup() %>% 
#   mutate(day2 = case_when(session == 1 ~ "no",
#                           session == 2 ~ "yes"),
#          day2 = factor(day2)) %>%
#   select(tp_mod, day2, everything())
# 
# t_gaze <- t_gaze %>%
#   # remove duplicates created by day2
#   group_by(subject) %>%
#   filter(!duplicated(tp_mod)) %>%   
#   ungroup() 
```

```{r, include = F}
# # filter data to only include time points from phase 1
# t_cau_p1 <- filter(t_cau, time_point < 15)
# t_inf_p1 <- filter(t_inf, time_point < 15)
# t_quant_p1 <- filter(t_quant, time_point < 15)
# t_gaze_p1 <- filter(t_gaze, time_point < 15)
# 
# # filter data to only include time points from phase 2
# t_cau_p2 <- filter(t_cau, time_point >= 15)
# t_inf_p2 <- filter(t_inf, time_point >= 15)
# t_quant_p2 <- filter(t_quant, time_point >= 15)
# t_gaze_p2 <- filter(t_gaze, time_point >= 15)
# t_grat_p2 <- filter(t_grat, time_point >= 15)
```

```{r}
# # formula for reference models
# fm <- formula(cogn ~ sick_severity +                    
#                 test_tp + test_day +             
#                 rel_rank + 
#                 observer_mod + 
#                 age + time_in_leipzig +
#                 sex + group +
#                 rearing +
#                 le_mean + dist_mean + 
#                 time_outdoors +
#                 sociality + time_point +
#                 (1|subject))
# # formula for gaze reference model
# fm_gaze <- formula(cogn ~ sick_severity +                    
#                      test_tp + test_day + time_point + day2 +            
#                      rel_rank + 
#                      observer_mod + 
#                      age + time_in_leipzig +
#                      sex + group +
#                      rearing +
#                      le_mean + dist_mean + 
#                      time_outdoors +
#                      sociality +
#                      (1 + time_point|subject))
```

```{r}
# m_cau_2l_p1 <- brm(fm, data = t_cau_p1,
#                    warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                    seed = 2021)
# m_inf_2l_p1 <- brm(fm, data = t_inf_p1,
#                    warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                    seed = 2021)
# m_quant_2l_p1 <- brm(fm, data = t_quant_p1,
#                      warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                      seed = 2021)
# m_gaze_2l_p1 <- brm(fm_gaze, data = t_gaze_p1,
#                     warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                     seed = 2021)
```

```{r}
# m_cau_2l_p2 <- brm(fm, data = t_cau_p2,
#                    warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                    seed = 2022)
# m_inf_2l_p2 <- brm(fm, data = t_inf_p2,
#                    warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                    seed = 2022)
# m_quant_2l_p2 <- brm(fm, data = t_quant_p2,
#                      warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                      seed = 2022)
# m_gaze_2l_p2 <- brm(fm_gaze, data = t_gaze_p2,
#                     warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                     seed = 2022)
# m_grat_2l_p2 <- brm(fm, data = t_grat_p2,
#                     warmup = 1e3, iter = 4e3, cores = ncores, chains = 4,
#                     seed = 2022)
```

```{r}
# all_fixed_effects <- c("sick_severity",
#                        "test_tp", "test_day", "time_point",
#                        "rel_rank",
#                        "observer_mod",
#                        "age", "time_in_leipzig",
#                        "sex", "group",
#                        "rearing",
#                        "le_mean", "dist_mean",
#                        "time_outdoors",
#                        "sociality")
# # delay random intercept to last place so that it doesn't soak up all the variance
# s_terms <- c("1", all_fixed_effects, 
#              paste0(paste(all_fixed_effects, collapse = " + "), 
#                     " + (1 | subject)")) 
# # gaze task gets its own search terms vector (including day2 and time_point (fixed/random))
# s_terms_gaze <- c("1", c(all_fixed_effects, "day2"), 
#                   paste0(paste(all_fixed_effects, collapse = " + "), 
#                          " + (1 | subject)"),
#                   paste0(paste(all_fixed_effects, collapse = " + "), 
#                          " + (time_point | subject)"))
```

#### Direct causal inference

```{r, warning = FALSE}
# cvs_cau_p1 <- cv_varsel(m_cau_2l_p1,
#                         search_terms = s_terms,
#                         cv_method = "LOO", method = "forward",
#                         seed = 2020)
# 
# saveRDS(cvs_cau_p1,"./saves/cvs_cau.rds")
# 
# cvs_cau <- readRDS("./saves/cvs_cau.rds")

```

```{r}
# cvarselp <- summary(cvs_cau, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "group"), "yes", "no"))
# 
# saveRDS(cvarselp, "./saves/cvs_cau_summary.rds")
# 
# ref_c_p1 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_cau$summaries$ref$lppd) , sqrt(mean((cvs_cau$refmodel$fit$data$cogn - cvs_cau$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_c_p1, "./saves/cvs_cau_ref.rds")


ref_c_p1 <-readRDS("./saves/cvs_cau_ref.rds") 

cvarselp <- readRDS("./saves/cvs_cau_summary.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
    rank = "Rank",
    age = "Age",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    time_point = "Time point",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)"
  ))


pcsel <- cvarselp%>%
ggplot(aes(x = size, y = value))+
  geom_hline(data = ref_c_p1, aes(yintercept = value), lty = 3)+
  geom_line(col = "black", alpha = .5)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  labs(y = "", x = "Predictors")+
  scale_x_continuous(labels = unique(cvarselp$solution_terms), breaks = unique(cvarselp$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")


```

```{r}
# cau_sol_terms <- c("(1 | subject)", "group")
# proj_cau_cv <- project(cvs_cau,  solution_terms = cau_sol_terms)
# 
# proj_samples_cau <- as.matrix(proj_cau_cv)%>%
#   as_tibble()%>%
#   pivot_longer(cols =c(1:8), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c("test_tp", "sigma", "Intercept"))%>%
#   mutate(factor = ifelse(grepl("group", pred), "group", "other predictors"),
#          pred = str_remove(pred,"group"),
#          pred = str_remove(pred,"rel_"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_cau,"./saves/proj_cvs_cau.rds")

proj_samples_cau <- readRDS("./saves/proj_cvs_cau.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
    rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    sexf = "Sex (female)",
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history"
  ))
  

pcpro <- ggplot(proj_samples_cau, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
  facet_grid(factor~., scales = "free", space = "free")+
  labs(y = "", x = "Estimate")+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))
```

```{r cselp, fig.height=4,fig.width=10, fig.cap = "Predictor selection for direct causal inference in Phase 1. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel. Reference level for group are bonobos.", out.width="100%"}
ggarrange(pcsel, pcpro, labels = c("A","B"), widths = c(1.5,1))
```

Supplementary Figure \@ref(fig:cselp) visualizes the results. Out of the 13 predictor variables we analysed, we selected only `group` to be relevant in addition to the random intercept term. When inspecting the projected posterior distribution for `group`, we saw substantial differences between the groups: Orangutans and the B-chimpanzee group performed best, followed by Bonobos (reference level) and finally the Gorillas and the A-chimpanzee group (see Supplementary Figure \@ref(fig:cselp)B).

#### Inference by exclusion

```{r, warning = F}
# cvs_inf_p1 <- cv_varsel(m_inf_2l_p1,
#                         search_terms = s_terms,
#                         cv_method = "LOO", method = "forward",
#                         seed = 2020)
# 
# saveRDS(cvs_inf_p1,"./saves/cvs_inf.rds")
# 
# cvs_inf <- readRDS("./saves/cvs_inf.rds")
```

```{r}
# ivarselp <- summary(cvs_inf, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "time_in_leipzig", "group", "age"), "yes", "no"))
# 
# saveRDS(ivarselp, "./saves/cvs_inf_summary.rds")
# 
# ref_i_p1 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_inf$summaries$ref$lppd) , sqrt(mean((cvs_inf$refmodel$fit$data$cogn - cvs_inf$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_i_p1, "./saves/cvs_inf_ref.rds")

ref_i_p1 <-readRDS("./saves/cvs_inf_ref.rds") 

ivarselp <- readRDS("./saves/cvs_inf_summary.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
    rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)"
  ))

pisel <- ivarselp%>%
ggplot(aes(x = size, y = value))+
  geom_hline(data = ref_i_p1, aes(yintercept = value), lty = 3)+
  geom_line(col = "black", alpha = .5)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
    labs(y = "", x = "Predictors")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  scale_x_continuous(labels = unique(ivarselp$solution_terms), breaks = unique(ivarselp$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")
```

```{r}
# inf_sol_terms <- c("(1 | subject)", "time_in_leipzig", "group", "age")
# proj_inf_cv <- project(cvs_inf,  solution_terms = inf_sol_terms)
# 
# proj_samples_inf <- as.matrix(proj_inf_cv)%>%
#   as_tibble()%>%
#   pivot_longer(cols =c(1:9), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c("test_tp", "sigma", "Intercept"))%>%
#   mutate(factor = ifelse(grepl("group", pred), "group", "other predictors"),
#          pred = str_remove(pred,"group"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_inf,"./saves/proj_cvs_inf.rds")

proj_samples_inf <- readRDS("./saves/proj_cvs_inf.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
    rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    sexf = "Sex (female)",
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history",
    `other predictors` = "Other predictors"
  ))

pipro <- ggplot(proj_samples_inf, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
facet_grid(factor~., scales = "free", space = "free")+
  xlim(-5,5)+
    labs(y = "", x = "Estimate")+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))
```

```{r iselp, fig.height=4, fig.width=10,fig.cap = "Predictor selection for inference by exclusion in Phase 1. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel.", out.width="100%"}
ggarrange(pisel, pipro, labels = c("A","B"), widths = c(1.5,1))
```

Supplementary Figure \@ref(fig:iselp) visualizes the results. For inference by exclusion, we selected `time_in_leipzig`, `group`, and `age` as relevant predictors in addition to the random intercept term. All three predictors capture stable individual characteristics.

Supplementary Figure \@ref(fig:iselp)B shows the projected posterior distributions for the predictors and suggests that the longer apes lived in Leipzig, the better their performance was. The differences between groups were such that the two chimpanzee groups together with the Gorillas performed on a higher level compared to the Bonobos (reference level) and Orangutans. With respect to `age`, we found that performance decreased with age.

#### Gaze Following

```{r, warning = F}
# cvs_gaze_p1 <- cv_varsel(m_gaze_2l_p1,
#                          search_terms = s_terms_gaze,
#                          cv_method = "LOO", method = "forward",
#                          seed = 2020)
# 
# saveRDS(cvs_gaze_p1,"./saves/cvs_gaze.rds")
# 
# cvs_gaze <- readRDS("./saves/cvs_gaze.rds")
```

```{r}
# gvarselp <- summary(cvs_gaze, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "group", "rearing", "time_outdoors", "age","sociality","sex","sick_severity", "observer_mod"), "yes", "no"))
# 
# saveRDS(gvarselp, "./saves/cvs_gaze_summary.rds")
# 
# ref_g_p1 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_gaze$summaries$ref$lppd) , sqrt(mean((cvs_gaze$refmodel$fit$data$cogn - cvs_gaze$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_g_p1, "./saves/cvs_gaze_ref.rds")

ref_g_p1 <-readRDS("./saves/cvs_gaze_ref.rds") 

gvarselp <- readRDS("./saves/cvs_gaze_summary.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer_mod = "Observer present",
    observer = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
    rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)",
    `other predictors` = "Other predictors"
  ))

pgsel <- gvarselp%>%
ggplot(aes(x = size, y = value))+
  geom_hline(data = ref_g_p1, aes(yintercept = value), lty = 3)+
  geom_line(col = "black", alpha = .5)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
      labs(y = "", x = "Predictors")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  scale_x_continuous(labels = unique(gvarselp$solution_terms), breaks = unique(gvarselp$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")
```

```{r}
# gaze_sol_terms_p1 <- c("(1 | subject)", "group", "rearing", "time_outdoors", "age","sociality","sex","sick_severity", "observer_mod")
# proj_gaze_cv <- project(cvs_gaze,  solution_terms = gaze_sol_terms_p1)
# 
# proj_samples_gaze <- as.matrix(proj_gaze_cv)%>%
#   as_tibble()%>%
#   pivot_longer(cols =everything(), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c("sigma", "Intercept"))%>%
#   mutate(factor = ifelse(grepl("group", pred), "group", ifelse(grepl("rearing", pred), "rearing",ifelse(grepl("sex", pred), "sex",ifelse(grepl("observer", pred),"Observer","other predictors")))),
#          pred = str_remove(pred,"group"),
#          pred = str_remove(pred,"rearing"),
#          pred = str_remove(pred,"sex"),
#          pred = str_remove(pred,"observer_mod"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_gaze,"./saves/proj_cvs_gaze.rds")

proj_samples_gaze <- readRDS("./saves/proj_cvs_gaze.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer_mod = "Observer present",
    observer = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    time_point = "Time point",
    age = "Age",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    sexf = "Sex (female)",
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history",
    `other predictors` = "Other predictors"
  ))

pgpro <- ggplot(proj_samples_gaze, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
facet_grid(factor~., scales = "free", space = "free")+
    labs(y = "", x = "Estimate")+
  scale_x_continuous(guide = guide_axis(n.dodge = 2), limits = c(-2,2))+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))
  
```

```{r gselp, fig.height=6, fig.width=10, fig.cap = "Predictor selection for gaze following in Phase 1. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel model.", out.width="100%"}
ggarrange(pgsel, pgpro, labels = c("A","B"), nrow = 1, widths = c(1.5,1))
```

Supplementary Figure \@ref(fig:gselp) visualizes the results. Gaze following had the most selected predictors of all tasks in Phase 1. In addition to the random intercept term, we selected `group`, `rearing`, `time_outdoors`, `age`, `sociality`, `sex`, `sick_severity`, and `observer`. Half of the predictors were stable individual characteristics, while the other half captured variable characteristics of experience.

Groups differed in that the two chimpanzee groups were most likely to follow gaze followed by the Bonobos (reference level). Gorillas and Orangutans were the least likely to follow the experimenter's gaze. Mother-reared individuals outperformed hand-reared individuals (including those with an unknown rearing history). The more time individuals spent outdoors, the more likely they were to follow gaze. Also, the probability to follow gaze increased with age. Individuals with a lower sociality index had higher rates of gaze following; females outperformed males. The rate of gaze following was lower when observers were present and when higher levels of sickness were reported for individuals. Supplementary Figure \@ref(fig:gselp)B visualizes these results.

#### Quantity discrimination

```{r, warning = F}
# cvs_quant_p1 <- cv_varsel(m_quant_2l_p1,
#                           search_terms = s_terms,
#                           cv_method = "LOO", method = "forward",
#                           seed = 2020)
# 
# saveRDS(cvs_quant_p1,"./saves/cvs_quant.rds")
# 
# cvs_quant <- readRDS("./saves/cvs_quant.rds")
```

```{r}
# qvarselp <- summary(cvs_quant, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "time_in_leipzig", "rearing", "group"), "yes", "no"))
# 
# saveRDS(qvarselp, "./saves/cvs_quant_summary.rds")
# 
# ref_q_p1 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_quant$summaries$ref$lppd) , sqrt(mean((cvs_quant$refmodel$fit$data$cogn - cvs_quant$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_q_p1, "./saves/cvs_quant_ref.rds")

ref_q_p1 <-readRDS("./saves/cvs_quant_ref.rds") 


qvarselp <- readRDS("./saves/cvs_quant_summary.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer_mod = "Observer present",
    observer = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    time_point = "Time point",
    age = "Age",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)"
  ))

pqsel <- qvarselp%>%
ggplot(aes(x = size, y = value))+
  geom_hline(data = ref_q_p1, aes(yintercept = value), lty = 3)+
  geom_line(col = "black", alpha = .5)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
        labs(y = "", x = "Predictors")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  scale_x_continuous(labels = unique(qvarselp$solution_terms), breaks = unique(qvarselp$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")
```

```{r}
# quant_sol_terms <- c("(1 | subject)", "time_in_leipzig", "rearing", "group") 
# proj_quant_cv <- project(cvs_quant,  solution_terms = quant_sol_terms)
# 
# proj_samples_quant <- as.matrix(proj_quant_cv)%>%
#   as_tibble()%>%
#   pivot_longer(cols =c(1:10), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c("test_tp", "sigma", "Intercept"))%>%
#   mutate(factor = ifelse(grepl("group", pred), "group", ifelse(grepl("rearing", pred), "rearing",ifelse(grepl("sex", pred), "sex","other predictors"))),
#          pred = str_remove(pred,"group"),
#          pred = str_remove(pred,"rearing"),
#          pred = str_remove(pred,"sex"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_quant,"./saves/proj_cvs_quant.rds")

proj_samples_quant <- readRDS("./saves/proj_cvs_quant.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
   sexf = "Sex (female)",
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history",
    `other predictors` = "Other predictors"
  ))

pqpro <- ggplot(proj_samples_quant, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
  facet_grid(factor~., scales = "free", space = "free")+
    labs(y = "", x = "Estimate")+
   xlim(-5,5)+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))
  
```

```{r qselp, fig.height=5, fig.width=10, fig.cap = "Predictor selection for quantity discrimination in Phase 1. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel model.", out.width="100%"}
ggarrange(pqsel, pqpro, labels = c("A","B"), nrow = 1, widths = c(1.5,1))
```

Supplementary Figure \@ref(fig:qselp) visualizes the results. For quantity, we selected three predictors in addition to the random intercept term: `time_in_leipzig`, `rearing`, and `group`. All of these predictors were stable individual characteristics.

The longer individuals had lived in Leipzig, the better they performed in the task. Group differences were such that b-chimpanzees performed best, followed by Bonobos (reference level) and Gorillas. A-Chimpanzees performed slightly worse, but still better than the Orangutans. Once again, mother reared individuals outperformed those who were hand-reared or whose rearing history was unknown. Supplementary Figure \@ref(fig:qselp)B visualizes these results.

#### Summary

The most obvious result was that the random intercept term `(1 | subject)` was -- by far -- the predictor that improved the model fit the most. This suggests that a large portion of the variance is explained by stable individual characteristics that we did not capture in our predictors. Most likely, these are the outcomes of idiosyncratic developmental processes or genetic pre-dispositions, which operate on a much longer time-scale than what we captured in our study.

Second, we saw that most of the relevant predictors came from the group of stable individual characteristics. This aligns well with the SEM results, in which we saw that most of the variance in performance could be traced back to stable trait differences between individuals. Following this reasoning, there was very little *systematic* variation between time points, and thus not much the time-varying predictors could account for. In line with this interpretation, we selected time point specific predictors only for gaze following, the task with the highest occasion specificity estimate according to the LST model.

The predictor selected most often was `group`. Differences between groups were, however, variable. The B-chimpanzee group tended to perform best across tasks, but the ranking of the other groups (including the other chimpanzee group) changed from task to task. This speaks against clear species differences in general cognitive performance. Again, the most likely explanation for group differences is an interaction between species specific dispositions and individual- / task-level developmental processes.

The predictors that were selected more than once influenced performance in a systematic way. Whenever rearing history was selected to be relevant, mother-reared individuals outperformed others. The more time an individual had lived in Leipzig, the better performance was. An exception was `age`, which had a positive estimate for gaze following but a negative one for inference.

When zooming out, except for `group`, none of the predictors was selected as important for all tasks. As noted above, the relative ranking of the groups varied from task to task.

```{r}
ro <- bind_rows(qvarselp%>%mutate(task = "quantity"),
          cvarselp%>%mutate(task = "causality"),
          ivarselp%>%mutate(task = "inference"),
          gvarselp%>%mutate(task = "gaze_following"),
)%>%
  filter(stat == "elpd", 
         solution_terms != "none",
         solution_terms != "day2",
         solution_terms != "(1 | subject)")%>%
  select(size, solution_terms, task, select)%>%
  group_by(solution_terms)%>%
  mutate(sum = sum(size))%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ),
  task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination","Strategy switching", "Delay of gratification")))

# ggplot(ro,aes(x = task, y = size, col = solution_terms))+
#   geom_line(aes(group = solution_terms))+
#   geom_point(aes(size = select))+
#   theme_minimal()+
#   labs(x = "", y = "Predictor rank based on PPI model")+
#   scale_y_reverse(breaks = c(1:15))+
#   scale_x_discrete(expand=c(0,0.7)) +
#   guides(col = F, size = F)+
#   geom_dl(aes(label = solution_terms),method = list(dl.trans(x = x + 0.5), "last.points", cex = 0.7))+
#   scale_color_viridis_d()
# 
# ggplot(ro,aes(x = fct_reorder(solution_terms,-sum), y = size, fill = task))+
#   #geom_line(aes(group = task))+
#   geom_bar(stat = "identity", position = position_dodge(), alpha = .75)+
#   theme_minimal()+
#   labs(x = "", y = "Predictor rank based on PPI model")+
#   coord_flip()+
#   scale_fill_viridis_d()


# pro <- ggplot(ro,aes(x = fct_reorder(solution_terms,sum), y = size, col = task))+
#   #geom_line(aes(group = task))+
#   geom_line(aes(group = task), alpha = .5)+
#   geom_point(aes(pch = select), size = 3)+
#   scale_shape_manual(values=c(1,4))+
#   theme_minimal()+
#   labs(x = "Predictor (ordered by average rank)", y = "Rank based on PPI model")+
#   scale_color_viridis_d(name = "Task")+
#   guides(shape = "none")+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
# pco <- ro%>%
#   ungroup()%>%
#   select(size, solution_terms,task)%>%
#   pivot_wider(names_from = "task", values_from = "size")%>%
#   select(-solution_terms)%>%
#   corrr::correlate(method = "spearman", quiet = T)%>%
#   gather(task, cor, -term)%>%
#   mutate(cor = replace(cor, duplicated(cor), NA))%>%
#   drop_na(cor)%>%
#   mutate(cor = round(cor,2))%>%
#   ggplot(aes(y = task, x = term, fill = cor, label = cor))+
#   geom_tile(color = "white")+
#   labs(x = "", y = "")+
#   scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "#FFE066", 
#   midpoint = 0, limit = c(-1,1), space = "Lab", name="Correlation")+
#   geom_text()+
#   scale_x_discrete(limits = c("gaze_following","inference","causality"))+
#   scale_y_discrete(limits = c("quantity","causality","inference"))+
#   theme_few()+
#   theme(legend.position = "right", legend.direction = "vertical", legend.title = element_blank())+
#   coord_fixed()
  
```

```{r selcomp, fig.height=3, fig.cap = "Ranking for each predictor and task. Crosses denote selected predictors.", out.width="100%"}
#pro
```

```{r cselcomp, fig.height=3, fig.cap = "Correlations of predictor rankings among the four tasks.", out.width="100%"}
#pco
```

### Phase 2

#### Direct causal inference

```{r}
# cvs_cau_p2 <- cv_varsel(m_cau_2l_p2,
#                         search_terms = s_terms,
#                         cv_method = "LOO", method = "forward",
#                         seed = 2022)
# 
# saveRDS(cvs_cau_p2,"./saves/cvs_cau_p2.rds")
# 
# cvs_cau_p2 <- readRDS("./saves/cvs_cau_p2.rds")
```

```{r}
# cvarselp_p2 <- summary(cvs_cau_p2, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "group", "time_outdoors"), "yes", "no"))
# 
# saveRDS(cvarselp_p2, "./saves/cvs_cau_summary_p2.rds")
# 
# ref_c_p2 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_cau_p2$summaries$ref$lppd) , sqrt(mean((cvs_cau_p2$refmodel$fit$data$cogn - cvs_cau_p2$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_c_p2, "./saves/cvs_cau_ref_p2.rds")

ref_c_p2 <-readRDS("./saves/cvs_cau_ref_p2.rds") 


cvarselp_p2 <- readRDS("./saves/cvs_cau_summary_p2.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    time_point = "Time point",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)"
  ))

pcsel_p2 <- cvarselp_p2%>%
ggplot(aes(x = size, y = value))+
  geom_hline(data = ref_c_p2, aes(yintercept = value), lty = 3)+
  geom_line(col = "black", alpha = .5)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  labs(y = "", x = "Predictors")+
  scale_x_continuous(labels = unique(cvarselp_p2$solution_terms), breaks = unique(cvarselp_p2$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")
```

```{r}
# cau_sol_terms_p2 <- c("(1 | subject)", "group", "time_outdoors")
# proj_cau_cv_p2 <- project(cvs_cau_p2, solution_terms = cau_sol_terms_p2)
# 
# proj_samples_cau_p2 <- as.matrix(proj_cau_cv_p2)%>%
#   as_tibble()%>%
#   pivot_longer(cols =c(1:8), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c("test_tp", "sigma", "Intercept"))%>%
#   mutate(factor = ifelse(grepl("group", pred), "group", "other predictors"),
#          pred = str_remove(pred,"group"),
#          pred = str_remove(pred,"rel_"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_cau_p2,"./saves/proj_cvs_cau_p2.rds")

proj_samples_cau_p2 <- readRDS("./saves/proj_cvs_cau_p2.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
   sexf = "Sex (female)",
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history"
  ))
  

pcpro_p2 <- ggplot(proj_samples_cau_p2, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
  facet_grid(factor~., scales = "free", space='free_y')+
  labs(y = "", x = "Estimate")+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))
```

```{r cselp2, fig.height=4,fig.width=10, fig.cap = "Predictor selection for direct causal inference in Phase 2. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel.", out.width="100%"}
ggarrange(pcsel_p2, pcpro_p2, labels = c("A","B"), widths = c(1.5,1))
```

Supplementary Figure \@ref(fig:cselp2) visualizes the results. In addition to the random intercept term, `group` and `time_outdoors` were selected as relevant predictors. When inspecting the projected posterior distribution for `time_outdoors`, we saw that performance was better on time points on which subjects spent less time outdoors. For `group`, we saw substantial differences between the groups: Orangutans and the B-chimpanzee group performed best, followed by Bonobos (reference level) and finally the Gorillas and the A-chimpanzee group (see Supplementary Figure \@ref(fig:cselp)B).

#### Inference by exclusion

```{r}
# cvs_inf_p2 <- cv_varsel(m_inf_2l_p2,
#                         search_terms = s_terms,
#                         cv_method = "LOO", method = "forward",
#                         seed = 2022)
# 
# saveRDS(cvs_inf_p2,"./saves/cvs_inf_p2.rds")
# 
# cvs_inf_p2 <- readRDS("./saves/cvs_inf_p2.rds")
```

```{r}
# ivarselp_p2 <- summary(cvs_inf_p2, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "group","time_in_leipzig","age"), "yes", "no"))
# 
# saveRDS(ivarselp_p2, "./saves/cvs_inf_summary_p2.rds")
# 
# ref_i_p2 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_inf_p2$summaries$ref$lppd) , sqrt(mean((cvs_inf_p2$refmodel$fit$data$cogn - cvs_inf_p2$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_i_p2, "./saves/cvs_inf_ref_p2.rds")

ref_i_p2 <-readRDS("./saves/cvs_inf_ref_p2.rds") 

ivarselp_p2 <- readRDS("./saves/cvs_inf_summary_p2.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    time_point = "Time point",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)"
  ))

pisel_p2 <- ivarselp_p2%>%
ggplot(aes(x = size, y = value))+
  geom_hline(data = ref_i_p2, aes(yintercept = value), lty = 3)+
  geom_line(col = "black", alpha = .5)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
    labs(y = "", x = "Predictors")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  scale_x_continuous(labels = unique(ivarselp_p2$solution_terms), breaks = unique(ivarselp_p2$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")
```

```{r}
# inf_sol_terms_p2 <- c("(1 | subject)", "group", "time_in_leipzig", "age", "time_point")  
# proj_inf_cv_p2 <- project(cvs_inf_p2,  solution_terms = inf_sol_terms_p2)
# 
# proj_samples_inf_p2 <- as.matrix(proj_inf_cv_p2)%>%
#   as_tibble()%>%
#   pivot_longer(cols  = everything(), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c("sigma", "Intercept"))%>%
#   mutate(factor = ifelse(grepl("group", pred), "group", "other predictors"),
#          pred = str_remove(pred,"group"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_inf_p2,"./saves/proj_cvs_inf_p2.rds")

proj_samples_inf_p2 <- readRDS("./saves/proj_cvs_inf_p2.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    sexf = "Sex (female)",
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history",
    `other predictors` = "Other predictors"
  ))

pipro_p2 <- ggplot(proj_samples_inf_p2, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
  facet_grid(factor~., scales = "free", space = "free")+
    labs(y = "", x = "Estimate")+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))
```

```{r iselp2, fig.height=4, fig.width=10,fig.cap = "Predictor selection for inference by exclusion in Phase 2. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel.", out.width="100%"}
ggarrange(pisel_p2, pipro_p2, labels = c("A","B"), widths = c(1.5,1))
```

Supplementary Figure \@ref(fig:iselp2) visualizes the results. For inference by exclusion, we selected `time_in_leipzig`, `group`, `age` and `time_point` as relevant predictors in addition to the random intercept term. All predictors )not counting `time_point`) captured stable individual characteristics. 

Supplementary Figure \@ref(fig:iselp2)B shows the projected posterior distributions for the predictors and suggests that the longer apes lived in Leipzig, the better their performance was. For `age` the results suggest better performance for younger individuals. The differences between groups were such that the B-chimpanzee group performed best, followed by the Gorillas. The remaining groups performed on a substantially lower level. The positive effect of `time_point` mirrors the likely learning effects discussed above. 

#### Gaze following

```{r}
# cvs_gaze_p2 <- cv_varsel(m_gaze_2l_p2,
#                          search_terms = s_terms_gaze,
#                          cv_method = "LOO", method = "forward",
#                          seed = 2022)
# 
# saveRDS(cvs_gaze_p2,"./saves/cvs_gaze_p2.rds")
# 
# cvs_gaze_p2 <- readRDS("./saves/cvs_gaze_p2.rds")
```

```{r}
# gvarselp_p2 <- summary(cvs_gaze_p2, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "group", "sex", "observer_mod", "age"), "yes", "no"))
# 
# saveRDS(gvarselp_p2, "./saves/cvs_gaze_summary_p2.rds")
# 
# ref_g_p2 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_gaze_p2$summaries$ref$lppd) , sqrt(mean((cvs_gaze_p2$refmodel$fit$data$cogn - cvs_gaze_p2$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_g_p2, "./saves/cvs_gaze_ref_p2.rds")

ref_g_p2 <-readRDS("./saves/cvs_gaze_ref_p2.rds") 


gvarselp_p2 <- readRDS("./saves/cvs_gaze_summary_p2.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    time_point = "Time point",
    rearing = "Rearing history",
    group = "Group",
    observer_mod = "Observer present",
    observer = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)",
    `other predictors` = "Other predictors",
    `(time_point | subject)` = "(time point | Subject)"
  ))

pgsel_p2 <- gvarselp_p2%>%
ggplot(aes(x = size, y = value))+
  geom_hline(data = ref_g_p2, aes(yintercept = value), lty = 3)+
  geom_line(col = "black", alpha = .5)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
      labs(y = "", x = "Predictors")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  scale_x_continuous(labels = unique(gvarselp_p2$solution_terms), breaks = unique(gvarselp_p2$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")
```

```{r}
# gaze_sol_terms_p2 <- c("(1 | subject)", "group", "sex", "observer_mod", "age")
# proj_gaze_cv_p2 <- project(cvs_gaze_p2,  solution_terms = gaze_sol_terms_p2)
# 
# proj_samples_gaze_p2 <- as.matrix(proj_gaze_cv_p2)%>%
#   as_tibble()%>%
#   pivot_longer(cols = everything(), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c("sigma", "Intercept"))%>%
#   mutate(factor = ifelse(grepl("group", pred), "group", ifelse(grepl("rearing", pred), "rearing",ifelse(grepl("sex", pred), "sex",ifelse(grepl("observer", pred),"Observer","other predictors")))),
#          pred = str_remove(pred,"group"),
#          pred = str_remove(pred,"rearing"),
#          pred = str_remove(pred,"sex"),
#          pred = str_remove(pred,"observer_mod"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_gaze_p2,"./saves/proj_cvs_gaze_p2.rds")

proj_samples_gaze_p2 <- readRDS("./saves/proj_cvs_gaze_p2.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer_mod = "Observer present",
    observer = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    sexf = "Sex (female)",
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history",
    `other predictors` = "Other predictors"
  ))

pgpro_p2 <- ggplot(proj_samples_gaze_p2, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
  facet_grid(factor~., scales = "free", space = "free")+
    labs(y = "", x = "Estimate")+
  scale_x_continuous(guide = guide_axis(n.dodge = 2))+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))

```

```{r gselp2, fig.height=6, fig.width=10, fig.cap = "Predictor selection for gaze following in Phase 2. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel model.", out.width="100%"}
ggarrange(pgsel_p2, pgpro_p2, labels = c("A","B"), nrow = 1, widths = c(1.5,1))
```


Supplementary Figure \@ref(fig:gselp2) visualizes the results. In addition to the random intercept term, we selected `group`,`sex`, `observer`, and `age`. All of these predictors were stable individual characteristics, with the exception of `observer`.

Groups differed in that individuals from the A-chimpanzee group were most likely to follow gaze, followed by the B-chimpanzee group and the bonbons (reference level). Gorillas and the Orangutans were less likely to follow gaze. Females outperformed males. The rate of gaze following was higher when no observer was present. Finally, the rate of gaze following further decreased with age. Supplementary Figure \@ref(fig:gselp2)B visualizes these results. Please not the unusual shape of the posterior distribution for some of the predictors. While we are confident about the selection of the selection process, we would caution against an overly strong interpretation of the absolute values of the projected estimates.

#### Quantity discrimination

```{r}
# cvs_quant_p2 <- cv_varsel(m_quant_2l_p2,
#                        search_terms = s_terms,
#                        cv_method = "LOO", method = "forward",
#                        seed = 2022)
# 
# saveRDS(cvs_quant_p2,"./saves/cvs_quant_p2.rds")
# 
# cvs_quant_p2 <- readRDS("./saves/cvs_quant_p2.rds")
```

```{r}
# qvarselp_p2 <- summary(cvs_quant_p2, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "rel_rank", "rearing", "time_in_leipzig", "group", "time_outdoors", "observer_mod", "test_tp"), "yes", "no"))
# 
# saveRDS(qvarselp_p2, "./saves/cvs_quant_summary_p2.rds")
# 
# ref_q_p2 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_quant_p2$summaries$ref$lppd) , sqrt(mean((cvs_quant_p2$refmodel$fit$data$cogn - cvs_quant_p2$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_q_p2, "./saves/cvs_quant_ref_p2.rds")

ref_q_p2 <-readRDS("./saves/cvs_quant_ref_p2.rds") 


qvarselp_p2 <- readRDS("./saves/cvs_quant_summary_p2.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    time_point = "Time point",
    rearing = "Rearing history",
    group = "Group",
    observer_mod = "Observer present",
    observer = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
     rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)"
  ))

pqsel_p2 <- qvarselp_p2%>%
ggplot(aes(x = size, y = value))+
  geom_hline(data = ref_q_p2, aes(yintercept = value), lty = 3)+
  geom_line(col = "black", alpha = .5)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
        labs(y = "", x = "Predictors")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  scale_x_continuous(labels = unique(qvarselp_p2$solution_terms), breaks = unique(qvarselp_p2$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")
```

```{r}
# quant_sol_terms_p2 <- c("(1 | subject)", "rel_rank", "rearing", "time_in_leipzig", "group", "observer_mod", "time_point") 
# proj_quant_cv_p2 <- project(cvs_quant_p2,  solution_terms = quant_sol_terms_p2)
# 
# proj_samples_quant_p2 <- as.matrix(proj_quant_cv_p2)%>%
#   as_tibble()%>%
#   pivot_longer(cols =everything(), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c( "sigma", "Intercept"))%>%
# mutate(factor = ifelse(grepl("group", pred), "group", ifelse(grepl("rearing", pred), "rearing",ifelse(grepl("sex", pred), "sex",ifelse(grepl("observer", pred),"Observer","other predictors")))),
#          pred = str_remove(pred,"group"),
#          pred = str_remove(pred,"rearing"),
#          pred = str_remove(pred,"sex"),
#          pred = str_remove(pred,"observer_mod"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_quant_p2,"./saves/proj_cvs_quant_p2.rds")

proj_samples_quant_p2 <- readRDS("./saves/proj_cvs_quant_p2.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
    rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    sexf = "Sex (female)", 
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history",
    `other predictors` = "Other predictors"
  ))

pqpro_p2 <- ggplot(proj_samples_quant_p2, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
  facet_grid(factor~., space = "free", scales = "free")+
    labs(y = "", x = "Estimate")+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))
  
```

```{r qselp2, fig.height=6, fig.width=10, fig.cap = "Predictor selection for quantity discrimination in Phase 2. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel model.", out.width="100%"}
ggarrange(pqsel_p2, pqpro_p2, labels = c("A","B"), nrow = 1, widths = c(1.5,1))
```

Supplementary Figure \@ref(fig:qselp2) visualizes the results. In addition to the random intercept term, we selected `rel_rank`, `rearing`, `time_in_leipzig`, `group`, `observer` and `time_point`. Two of the five predictors (excluding `time_point`) captured more variable aspects of experience.

Supplementary Figure \@ref(fig:iselp2)B shows the projected posterior distributions for the predictors. Higher ranking individuals performed better in the task. Mother-reared individuals performed better compared to hand-reared individuals. The more time the individual had spent in Leipzig, the better the performance. With respect to `group`, we found that the B-chimpanzee group performed above the Bonobos (reference level) which in turn were better compared to the other groups. Performance was better, when there was no observer. Finally, individuals who had already participated in another study on the same day showed better performance. The effect of `time_point` suggested a slight increase in performance over time. 

#### Delay of gratification

```{r}
# cvs_grat_p2 <- cv_varsel(m_grat_2l_p2,
#                          search_terms = s_terms,
#                          cv_method = "LOO", method = "forward",
#                          seed = 2022)
# 
# saveRDS(cvs_grat_p2,"./saves/cvs_grat_p2.rds")
# 
# cvs_grat_p2 <- readRDS("./saves/cvs_grat_p2.rds")
```

```{r}
# dgvarselp_p2 <- summary(cvs_grat_p2, stats = c('elpd', 'rmse'))%>%
#   tibble()%>%
#   pivot_longer(cols = c(elpd,rmse), values_to = "value", names_to = "stat")%>%
#   pivot_longer(cols = c(elpd.se,rmse.se), values_to = "se", names_to = "se_term")%>%
#   rowwise()%>%
#   filter(grepl(stat,se_term))%>%
#   select(-se_term)%>%
#   mutate(solution_terms = factor(ifelse(is.na(solution_terms),"none",solution_terms)),
#          select = ifelse(solution_terms  %in% c("(1 | subject)", "time_in_leipzig", "observer_mod", "sex", "rel_rank", "sick_severity"), "yes", "no"))
# 
# saveRDS(dgvarselp_p2, "./saves/cvs_grat_summary_p2.rds")
# 
# ref_d_p2 <- tibble(
#   stat = c('elpd', 'rmse'),
#   value = c(sum(cvs_grat_p2$summaries$ref$lppd) , sqrt(mean((cvs_grat_p2$refmodel$fit$data$cogn - cvs_grat_p2$summaries$ref$mu)^2)))
# )
# 
# saveRDS(ref_d_p2, "./saves/cvs_grat_ref_p2.rds")

ref_d_p2 <-readRDS("./saves/cvs_grat_ref_p2.rds") 

dgvarselp_p2 <- readRDS("./saves/cvs_grat_summary_p2.rds")%>%
  mutate(solution_terms = recode(solution_terms,
    time_in_leipzig = "Time spent in research",
    time_point = "Time point",
    rearing = "Rearing history",
    group = "Group",
    observer_mod = "Observer present",
    observer = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
    rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    f = "Female", 
    m = "Male",
    hand = "Hand-reared",
    mother = "Mother-reared",
    `(1 | subject)` = "(1 | Subject)"
  ))

pdgsel_p2 <- dgvarselp_p2%>%
ggplot(aes(x = size, y = value))+
  geom_line(col = "black", alpha = .5)+
  geom_hline(data = ref_d_p2, aes(yintercept = value), lty = 3)+
  geom_pointrange(aes(ymin = value - se, ymax = value + se, col = select), size = 0.5, pch = 4)+
  facet_grid(stat~., scale = "free_y")+
        labs(y = "", x = "Predictors")+
  scale_color_manual(name = "relevant", values = c("black", "firebrick"))+
  scale_x_continuous(labels = unique(dgvarselp_p2$solution_terms), breaks = unique(dgvarselp_p2$size))+
  theme_few()+
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        legend.position = c(0.5,0.9), legend.direction = "horizontal")
```

```{r}
# grat_sol_terms_p2 <- c("(1 | subject)", "time_in_leipzig", "observer_mod", "sex")
# proj_grat_cv_p2 <- project(cvs_grat_p2,  solution_terms = grat_sol_terms_p2)
# 
# proj_samples_grat_p2 <- as.matrix(proj_grat_cv_p2)%>%
#   as_tibble()%>%
#   pivot_longer(cols =everything(), names_to = "pred", values_to = "value")%>%
#   filter(!pred%in%c("test_tp", "sigma", "Intercept"))%>%
# mutate(factor = ifelse(grepl("group", pred), "group", ifelse(grepl("rearing", pred), "rearing",ifelse(grepl("sex", pred), "sex",ifelse(grepl("observer", pred),"Observer","other predictors")))),
#          pred = str_remove(pred,"group"),
#          pred = str_remove(pred,"rearing"),
#          pred = str_remove(pred,"sex"),
#          pred = str_remove(pred,"observer_mod"),
#          species = ifelse(factor == "group", pred,factor))
# 
# saveRDS(proj_samples_grat_p2,"./saves/proj_cvs_grat_p2.rds")

proj_samples_grat_p2 <- readRDS("./saves/proj_cvs_grat_p2.rds")%>%
  filter(!grepl("Intercept",pred))%>%
  mutate(pred = recode(pred,
    time_in_leipzig = "Time spent in research",
    rearing = "Rearing history",
    group = "Group",
    observer = "Observer present",
    observer_mod = "Observer present",
    sex = "Sex",
    rel_rank = "Rank",
    rank = "Rank",
    age = "Age",
    time_point = "Time point",
    sick_severity = "Sickness severity",
    test_tp = "Study participation (day)",
    test_day = "Study participation (time point)",
    time_outdoors = "Time spent outdoors",
    dist_mean = "Disturbance",
    le_mean = "Life event",
    sociality = "Sociality",
    a_chimp = "Chimpanzee group A",
    b_chimp = "Chimpanzee group B",
    bonobo = "Bonobo",
    orangutan = "Orangutan",
    gorilla = "Gorilla",
    sexf = "Sex (female)", 
    rearingmother = "Rearing (mother-reared)",
    observer_modyes = "Observer present",
    `(1 | subject)` = "(1 | Subject)"
  ))%>%
  mutate(factor = recode(factor,
    group = "Group",
    sex = "Sex",
    rearing = "Rearing history",
    `other predictors` = "Other predictors"
  ))

pdgpro_p2 <- ggplot(proj_samples_grat_p2, aes(x = value, y = pred)) +
  geom_vline(xintercept = 0, lty = 2, alpha = .75)+
  geom_density_ridges(alpha = .5, scale = .7) +
  facet_grid(factor~., space = "free", scales = "free")+
    labs(y = "", x = "Estimate")+
  theme_minimal()+
  theme(panel.border = element_rect(color = "black",fill = NA,size = 1))
  
```

```{r dgselp2, fig.height=4, fig.width=10, fig.cap = "Predictor selection for delay of gratification in Phase 2. A) Elpd and RMSE values (with standard error) for predictors based on data from N = 43 participants, ordered by importance (left to right) according to the cross-validated projection prediction model. Note that the random intercept term was forced to be the last one to be included. B) Projections for the selected predictors based on the submodel model.", out.width="100%"}
ggarrange(pdgsel_p2, pdgpro_p2, labels = c("A","B"), nrow = 1, widths = c(1.5,1))
```

Supplementary Figure \@ref(fig:dgselp2) visualizes the results. In addition to the random intercept term, we selected `time_in_leipzig`, `observer`, and `sex`. Notably, delay of gratification was the only task for which `group` was not selected as a predictor. 

Individuals who have spent more time in Leipzig were more likely to delay gratification. Waiting for the bigger reward was also more likely when there was no observer present. Males  also had higher rates of waiting. Supplementary Figure \@ref(fig:dgselp2)B visualizes these results.

#### Summary

Once again, the random intercept term `(1 | subject)` was the predictor that improved the model fit the most. Predictors capturing stable individual characteristics were selected most often, which aligns well with the SEM results, in which we saw that most of the variance in performance could be traced back to stable trait differences between individuals. The tasks with the highest occasion-specific variance (gaze following and delay of gratification, see Supplementary Figure \@ref(fig:lsteplot2)) were also those for which the most time point specific predictors were selected. However, the quantity discrimination task did not fit this pattern; even though the LST model suggested that only a very small portion of the variance in performance was occasion specific, three time point specific variables were selected to be relevant. 

The predictor selected most often was `group`. The differences between groups were, however, variable with no obvious pattern. The two chimpanzee groups varied largely independent from each other. Thus, it makes more sense to interpret this as differences between groups rather than species.

The way in which the predictors that were selected more than once influenced performance was largely coherent. The presence of observers always had a negative effect on performance. The more time an individual had lived in Leipzig, the better performance was. Higher-ranking individuals outperformed lower-ranking ones. Finally, younger individuals outperformed older ones. An Exception was `sex`: females were more likely to follow gaze than males, but males were more likely to wait for the larger reward in the delay of gratification task.

Taken together, there was no single predictor that was selected as important for all tasks. The most important predictor across tasks was `group`, but the relative ranking of groups was not consistent across tasks. 

### Comparison between phases

```{r}
ro <- bind_rows(
  qvarselp%>%mutate(task = "quantity")%>%mutate(phase = "Phase 1"),
  cvarselp%>%mutate(task = "causality")%>%mutate(phase = "Phase 1"),
  ivarselp%>%mutate(task = "inference")%>%mutate(phase = "Phase 1"),
  gvarselp%>%mutate(task = "gaze_following")%>%mutate(phase = "Phase 1"),
  
  qvarselp_p2%>%mutate(task = "quantity")%>%mutate(phase = "Phase 2"),
  cvarselp_p2%>%mutate(task = "causality")%>%mutate(phase = "Phase 2"),
  ivarselp_p2%>%mutate(task = "inference")%>%mutate(phase = "Phase 2"),
  gvarselp_p2%>%mutate(task = "gaze_following")%>%mutate(phase = "Phase 2"),
  dgvarselp_p2%>%mutate(task = "delay_of_gratification")%>%mutate(phase = "Phase 2"),
)%>%
  filter(stat == "elpd", 
         solution_terms != "none",
         solution_terms != "day2",
         solution_terms != "(1|subject)",
         solution_terms != "(1 | Subject)",
         solution_terms != "(time_point | subject)",
         solution_terms != "(time point | Subject)",
         solution_terms != "Time point",
         solution_terms != "time_point")%>%
  select(size, solution_terms, task,phase, select)%>%
  group_by(solution_terms)%>%
  mutate(sum = sum(size))%>%
  ungroup()%>%
  droplevels()%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination"
  ))%>%
  mutate(task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination", "Delay of gratification"),labels = c("Gaze \nfollowing", "Causal \ninference","Inference \nby exclusion" ,"Quantity \ndiscrimination", "Delay of \ngratification")))%>%
  mutate(type = ifelse(
    solution_terms == "Time spent in research" | solution_terms == "Rearing history" | solution_terms == "Group" | solution_terms == "Sex"| solution_terms == "Age", "Stable characteristic", ifelse(
      solution_terms == "Rank" | solution_terms == "Sickness severity" | solution_terms == "Sociality" ,"Variable characteristic", ifelse(
        solution_terms == "Time spent outdoors" | solution_terms == "Disturbance" | solution_terms == "Life event", "Group life", "Testing arrangement"
      )
    )
  ))


ppicomp <- ggplot(ro,aes(x = fct_reorder(solution_terms,sum), y = size, lty = phase, col = type ))+
  #geom_line(aes(group = task))+
  geom_line(aes(group = phase), alpha = .5, col = "black")+
  geom_point(aes(pch = select), size = 2, stroke = 1)+
  theme_minimal()+
  facet_grid(task~.)+
  labs(x = "", y = "Rank based on PPI model")+
  scale_color_brewer(palette="Set1", name = "")+
  scale_linetype(name = "")+
  scale_shape_manual(name = "", values =  c(1,4), labels = c("Irrelevant", "Relevant"))+
  scale_y_reverse(breaks = c(15,10,5,1), limits = c(16,0))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right", 
        legend.spacing.y = unit(0, 'cm'),
        #legend.spacing.x = unit(0, 'cm'),
        panel.border  = element_rect(colour = "black",fill = NA)
        )

```

```{r ppisum, fig.height=6, fig.width=8, fig.cap = "Predictor ranking and selection based on PPI models for Phase 1 and Phase 2. Different linetypes show the different phases, crosses mark predictors that were selected to be relevant based on the PPI models. Color shows the broader category each predictor belongs to. The x-axis is sorted by the average rank across tasks and phases.", out.width="100%"}
ppicomp
```
Supplementary Figure \@ref(fig:ppisum)) shows the predictor ranking and selection across tasks and phases. For the following comparison between the two phases, we focus on the tasks that were part of both. The picture that emerges is one of consistency with occasional variability. 

Inference by exclusion was the most consistent of all tasks, that is, the same predictors were selected to be relevant in both phases (`group`,`time_in_leipzig`, `age`). Furthermore, theses predictors were ranked in the same order. 

For direct causal inference, the highest ranked predictor was the same in both phases (`group`). However, in Phase 2, `time_outdoors` was also selected to be relevant even though it had received a fairly low rank in Phase 1.

For quantity discrimination, all predictors that were selected in Phase 1 were also selected in Phase 2 (`time_in_leipzig`, `rearing`, `group`, similar ranking in both Phases), however, Phase 2 two additional -- time point specific -- predictors:`rank` and ``observer`. 

The gaze following task was the only one for which some of the predictors selected in Phase 1 were not selected in Phase 2 (`rearing`, `time_outdoors`, `sociality`, `sick_severity`). However, except for `time_outdoors`, despite not being selected, the ranking of the predictors was similar. The divergence for `time_outdoors` can largely be explained by the initial habituation we saw in gaze following at the beginning of Phase 1 (Supplementary Figure \@ref(fig:perfplot)) which coincided with a seasonal decline in time spent outdoors (Supplementary Figure \@ref(fig:glife)). At the beginning of Phase 2, gaze following rates remained low while time spent outdoors was high again. Thus, the result of Phase 1 is likely to be a mere artifact. Overlapping predictors between phases were `group`, `age`, `observer`, and `sex`. The case of `observer` is the only one in which a variable predictor was selected in both phases.

The consistency between phases was that for most tasks the predictors selected as relevant in Phase 1 were again selected in Phase 2. This constitutes solid evidence that there is a systematic and consistent relation between performance and these predictors. All predictors that were selected twice capture stable individual differences (`group`, `age`, `time_in_leipzig`, `rearing`), echoing once again the results of the LST models. Variability showed itself in the time point specific variables. There was no overlap in time point specific predictors between Phase 1 and 2. This suggests that cognitive performance *is* influenced by temporal variation in group life, testing arrangements and variable characteristics, the way this happens, however, is either less consistent or less pronounced (or both). 

The stable individual characteristics that turned out to be systematically related to performance varied across tasks. That is, except for `group`, none of the predictors was relevant for all tasks. The ranking of the different groups varied across tasks, with no clear pattern. That is, none of the groups consistently performed better or worse compared to the others across tasks. There seems to be no one-size-fits-all predictor of cognitive abilities in great apes.  

# Summary

When reflecting on the results presented here, we can draw the following tentative conclusions: First, the majority of tasks produced robust task-level results and showed relatively high re-test correlations. Exceptions were the switching task -- which produced no interpretable individual differences -- and the quantity discrimination task, which produced robust task-level results but less reliable individual differences. Thus, assessing the psychometric properties of tasks is an important prerequisite to contextualize and interpret the results of individual differences studies in great apes.  

We saw that individual differences in performance were best explained by stable differences in cognitive abilities between individuals. This does not mean that these abilities are time-invariant. For the inference by exclusion task, we saw that some individuals quickly improved, leading to a re-ordering of individual difference. It means that change is systematic and potentially long-lasting, reflecting a change in the underlying cognitive abilities. 

Performance was best predicted by variables that captured stable individual characteristics such as group membership, age or experience with research. This aligns well with the stability of individual differences mentioned above. However, the single most important predictor of performance was a term that simply reflected the identity of the individual. This suggests that the -- fairly comprehensive -- set of predictors that we studied here do not fully explain cognitive performance in great apes. Most likely, idiosyncratic developmental processes in combination with genetic pre-dispositions -- which operate on a much longer time-scale -- are the source of these unexplained individual differences.

# Supplementary Note {#appendix}

## Analysis and results

### Latent state-trait models with autoregressive effects (LST-AR)

LST-AR models extend LST models by accounting for potential carry-over effects between temporally adjacent observations. The autoregressive effects thereby capture accumulated situational effects, that is, effects of previously experienced situations on subsequent trait levels [@eid2017definition]. For instance, a person that experiences a great success at work at time $t$ may not only show greater job satisfaction as compared to their habitual trait level at that point in time, but an increase in job satisfaction that lasts across a prolonged time period (i.e., change in the habitual trait level at time $t'$ with $t' > t$ due to the positive experience at time $t$). LST-AR models allow us to quantify the temporal predictability of performance based on occasion-specific variance in the previous time points. This is captured in the (autoregressive) predictability coefficient and quantifies how much of the variation in performance can be explained by the variation in the occasion-specific variables at the previous time point (note that the names of the coefficients used here slightly differ from those used in @eid2017definition).

#### Model description

The following model is a restrictive variant of the model described in @eid2017definition. The model is depicted for six measurement time points in Supplementary Figure \@ref(fig:lstrgraph).

```{r lstrgraph, engine='tikz', fig.cap="Latent State-Trait model with autoregressive effects for two indicators and six measurement time points. All factor loadings of the latent trait factor $T$ are fixed to 1 (not displayed in the figure)", out.width="35%", fig.align='center'}

\usetikzlibrary{arrows} 
\usetikzlibrary{positioning} 
\usetikzlibrary{shapes} 
\usetikzlibrary{fit} 
\usetikzlibrary{backgrounds} 
\usetikzlibrary{calc}

\begin{tikzpicture}
 [manifest/.style={rectangle,draw=black!80,semithick,minimum width=1.5cm,inner sep=
4pt,text centered},
        latent/.style={ellipse,draw=black!80,thick,inner sep=2,text centered},
        on/.style={->,>=stealth',semithick},
        from/.style={<-,>=stealth',semithick},
        with1/.style={<->,>=stealth',semithick,bend left=30},
        with2/.style={<->,>=stealth',semithick,bend right=30},
        with3/.style={<->,>=stealth',semithick,bend left=50},]


% Latent Variables %
 \begin{scope}[node distance=1.5]
                \node[latent] (o1) at (0,0) {$\zeta_{1}$};
                \node[latent] (o2) [below=of o1] {$O_{2}$}
                edge [from] node[right] {$\beta$} (o1);
                \node[latent] (o3) [below=of o2] {$O_{3}$}
                edge [from] node[right] {$\beta$} (o2);
                \node[latent] (o4) [below=of o3] {$O_{4}$}
                edge [from] node[right] {$\beta$} (o3);
                \node[latent] (o5) [below=of o4] {$O_{5}$}
                edge [from] node[right] {$\beta$} (o4);
                \node[latent] (o6) [below=of o5] {$O_{6}$}
                edge [from] node[right] {$\beta$} (o5);
\end{scope}

\foreach \a in {2,...,6} {\node [below left = .4 of o\a] (zeta\a) {$\zeta_{\a}$}
	edge [on] (o\a);}
                     
% Trait % 
\node[latent,node distance=7] (t) [right=of  o4]  {$T_{}$};
                                             	                        
% Manifest % 
 \foreach \a in {1,...,6} {\node (y1\a) [right = 2 of o\a] (yhelp\a) {};}        
 \foreach \b in {1,...,6} {\node[manifest] [above = .05 of yhelp\b] (y1\b) {$Y^*_{1\b}$}
 	edge [from] node[above] {1} (o\b);}
 \foreach \c in {1,...,6} {\node[manifest] [below = .05 of yhelp\c] (y2\c) {$Y^*_{2\c}$}
 	edge [from] node[below] {$1$} (o\c);} 

% Fehler %
\foreach \a in {1,...,5} {\node (e1\a) [below right = .3 of y1\a] {}
	edge [on] (y1\a.south east);}
\foreach \b in {1,...,5} {\node (e2\b) [below right = .3 of y2\b] {}
	edge [on] (y2\b.south east);}

\node (e16) [below right = .3 of y16] {$\epsilon_{16}$}
	edge [on] (y16.south east);
\node (e26) [below right = .3 of y26] {$\epsilon_{26}$}
	edge [on] (y26.south east);

% Pfeile %
\foreach \a in {1,...,6}
	\path (y1\a.0) edge [from] (t);
\foreach \a in {1,...,6}	
	\path (y2\a.0) edge [from] (t);
\end{tikzpicture}

```

Measurement equation for parcel $i$ at time point $t$:

```{=tex}
\begin{equation}
Y^*_{it}= T + O_t + \epsilon_{it}
\end{equation}
```
where $T$ is the latent trait variable, the occasion-specific variables $O_t$ capture time-specific deviations of the respective true score from the latent trait variable $T$, and $\epsilon_{it}$ is a measurement error variable, with $\epsilon_{it} \sim N(0,1) ~\forall i,t$. $O_t$ is assumed to follow an autoregressive process of order 1 across time (within subjects), that is:

```{=tex}
\begin{align}
O_t  &= \zeta_t ~~~~~~~~t = 1 \notag \\
O_t  &= \beta O_{(t-1)} + \zeta_t~~~~~~~~t > 1 \notag
\end{align}
```
where the latent state residual variables $\zeta_t$ capture true time-specific inter-individual differences that cannot be explained based on the true score of previous measurement time points. We make the same assumptions about factorial invariance as in the LST model.

The following variance coefficients can be computed. Note that the names of the coefficients used here slightly differ from those used in @eid2017definition.

##### Consistency

Proportion of true variance (i.e., measurement-error free variance) that is due to true inter-individual stable trait differences.

```{=tex}
\begin{equation}
Con(Y^*_{it})=\frac{Var(T)}{Var(T)+\beta^2 Var(O_{(t-1)})+Var(\zeta_t)}
\end{equation}
```
##### Occasion specificity

Proportion of true variance (i.e., measurement-error free variance) that is due to true inter-individual differences in the state residual variables, that is occasion-specific variation that is not explained by the autoregressive process or the trait variable $T$.

```{=tex}
\begin{equation}
OS(Y^*_{it}) = \frac{Var(\zeta_t)}{Var(T)+\beta^2 Var(O_{(t-1)})+Var(\zeta_t)}
\end{equation}
```
As the proportion of variance explained by the autoregressive process stabilizes over time, all coefficients have converged to a relatively stable value at $t=14$, indicating the long-term proportions of variance that are to be expected.

##### Autoregressive predictability

Proportion of true variance that is explained by carry-over effects from previous measurement time points:

```{=tex}
\begin{equation}
Pred(Y^*_{it}) = \frac{\beta^2 Var(O_{(t-1)})}{Var(T)+\beta^2 Var(O_{(t-1)})+Var(\zeta_t)}
\end{equation}
```
#### Results

```{r, include = F}
# latent state trait models with auto regressive component
lstarc <- readModels("../supplement/saves/test_apes_data_LST_cau_equSvar_AR1.out")
lstari <- readModels("../supplement/saves/test_apes_data_LST_inf_equSvar_AR1.out")
lstarq <- readModels("../supplement/saves/test_apes_data_LST_quant_equSvar_AR1.out")
lstarg <- readModels("../supplement/saves/test_apes_data_LST_gaze_equSvar_AR1.out")

lstarc2 <- readModels("../supplement/saves/test_apes_data_LST_cau_equSvar_AR1_2.out")
lstari2 <- readModels("../supplement/saves/test_apes_data_LST_inf_equSvar_AR1_2.out")
lstarq2 <- readModels("../supplement/saves/test_apes_data_LST_quant_equSvar_AR1_2.out")
lstarg2 <- readModels("../supplement/saves/test_apes_data_LST_gaze_equSvar_AR1_2.out")
lstard2 <- readModels("../supplement/saves/test_apes_data_LST_delay_equSvar_AR1_2.out")
```

```{r}
motar <- tibble(
  Phase = c("Phase 1","","","","Phase 2","","","",""),
  Task = c("Causal inference","Inference by exclusion","Gaze following", "Quantity discrimination","Causal inference","Inference by exclusion","Gaze following", "Quantity discrimination", "Delay of  Gratification"),
  PPP = c(
    lstarc$summaries$PostPred_PValue,
    lstarg$summaries$PostPred_PValue,
    lstari$summaries$PostPred_PValue,
    lstarq$summaries$PostPred_PValue,
    
    lstarc2$summaries$PostPred_PValue,
    lstarg2$summaries$PostPred_PValue,
    lstari2$summaries$PostPred_PValue,
    lstarq2$summaries$PostPred_PValue,
    lstard2$summaries$PostPred_PValue),
  
  `Chi 95% CI` = c(
    paste(
      lstarc$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstarc$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(
      lstarg$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstarg$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(
      lstari$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstari$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(
      lstarq$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstarq$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    
    paste(
      lstarc2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstarc2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(
      lstarg2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstarg2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(
      lstari2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstari2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(
      lstarq2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstarq2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "),
    paste(
      lstard2$summaries$ObsRepChiSqDiff_95CI_LB%>%round(2)%>%format(nsmall =2),
      lstard2$summaries$ObsRepChiSqDiff_95CI_UB%>%round(2)%>%format(nsmall =2), sep = " ; "))
)
```

```{r semtar}
kable(motar, align = c("l", "l", "c", "c"), caption = "Model fit indices for LST-AR models", booktabs=TRUE)%>%
kable_classic(full_width = F)%>%
      footnote(c("PPP = Posterior predictive p-value. Cut-off values (two-tailed): 0.025 and 0.975", "Chi 95% CI = 95%CI of difference between predicted and observed chi-square values"))
```

All LST-AR models in Phase 1 and Phase 2 fit the data reasonably well (see Supplementary Table \@ref(tab:semtar)). The model estimates for consistency, occasion specificity and reliability were largely similar to the LST model models (see Supplementary Figure \@ref(fig:lstardifplot)). There were some pronounced differences: most notably, the models for the inference by exclusion and quantity discrimination tasks had very high predictability estimates in Phase 2. However, these results should be interpreted with caution. First, the credible intervals for the parameter estimates for consistency and predictability were very wide -- covering the whole range of possible values between 0 and 1 -- suggesting that the model was in fact unable to precisely quantify the two components.

More importantly, however, the $\beta$ coefficients that quantify the auto-regressive effect suggest that the models were in fact unidentifiable [see also @ludtke2018more]. The upper bound for $\beta$ is 1 (i.e. 100% of true score variance of $t_i$ is predicted by the residual state variance of $t_{i-1}$) and the 95% CIs for the parameter estimates for the models in question included values that were larger than that (Supplementary Figure \@ref(fig:lstarbeta)). This was also the case for the direct causal inference model of Phase 2. Because of this issue, and because the unproblematic models did not yield different interpretations from the LST models, we did not use the LST-AR models to interpret the results.

```{r}
lstare<- bind_rows(
  lstarc$parameters$unstandardized%>%mutate(task = "causality")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstari$parameters$unstandardized%>%mutate(task = "inference")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstarq$parameters$unstandardized%>%mutate(task = "quantity")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstarg$parameters$unstandardized%>%mutate(task = "gaze_following")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstarc$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "causality"),
  lstari$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "inference"),
  lstarq$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "quantity"),
  lstarg$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "gaze_following")
  )%>%
  filter(!grepl("DIF",param), 
         param != "CON1")%>%
  separate(param, 
           into = c("param", "time_point"), 
           sep = "(?<=[A-Za-z])(?=[0-9])"
           )%>%
  filter(time_point != "4")%>%
  mutate(time_point = as.numeric(time_point),
         param = recode(param, CON = "Consistency", OSP = "Occasion specificity", REL = "Reliability", PRED = "Predictability"))

lstare2<- bind_rows(
  lstarc2$parameters$unstandardized%>%mutate(task = "causality")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstari2$parameters$unstandardized%>%mutate(task = "inference")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstarq2$parameters$unstandardized%>%mutate(task = "quantity")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstarg2$parameters$unstandardized%>%mutate(task = "gaze_following")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstard2$parameters$unstandardized%>%mutate(task = "delay_of_gratification")%>%filter(paramHeader== "New.Additional.Parameters"),
  lstarc2$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "causality"),
  lstari2$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "inference"),
  lstarq2$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "quantity"),
  lstarg2$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "gaze_following"),
  lstard2$parameters$r2%>%filter(grepl("P",param))%>%mutate(param = str_replace(param,"P1","REL"))%>%filter(param == "REL2"|param == "REL3" |param == "REL14")%>%mutate(task = "delay_of_gratification")
  )%>%
  filter(!grepl("DIF",param), 
         param != "CON1")%>%
  separate(param, 
           into = c("param", "time_point"), 
           sep = "(?<=[A-Za-z])(?=[0-9])"
           )%>%
  filter(time_point != "4")%>%
  mutate(time_point = as.numeric(time_point),
         param = recode(param, CON = "Consistency", OSP = "Occasion specificity", REL = "Reliability", PRED = "Predictability"))%>%
   mutate(task = factor(task, levels = c("causality", "gaze_following", "inference", "quantity", "delay_of_gratification")))
```

```{r}
lstardif <- bind_rows(
  lstare%>%mutate(phase = "Phase 1"),
  lstare2%>%mutate(phase = "Phase 2")
)%>%filter(time_point == 14)%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))%>%
  mutate(task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination", "Delay of gratification")))
  
plstardif <- ggplot(lstardif,aes(x = param, y = est, col = phase))+
  facet_wrap(~task)+
  labs(x = "Time point",y = "Estimate")+
  #geom_line(aes(group = phase),position = position_dodge(width = 0.2), alpha = .75)+
  geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci),position = position_dodge(width = 0.2), alpha = .75, size = .25)+
  scale_color_discrete(name = "Phase")+
  theme_few()+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(#legend.text=element_text(size=7), legend.key.size = unit(0.4,"cm"),
    legend.position = c(0.8,0.2), legend.box = "vertical", legend.spacing.x = unit(0, 'cm'), legend.spacing.y = unit(0, 'cm'))

```

```{r lstardifplot, fig.height = 4, fig.cap = "Posterior means of LSTM-AR estimates for time point 14 for Phase 1 and Phase 2 with 95\\% CrI based on data from N = 43 participants.", out.width="100%"}
plstardif
```

```{r}
lstar_beta <- bind_rows(
  lstarc$parameters$unstandardized%>%mutate(task = "causality", phase = "Phase 1")%>%filter(paramHeader== "S14.ON"),
  lstari$parameters$unstandardized%>%mutate(task = "inference", phase = "Phase 1")%>%filter(paramHeader== "S14.ON"),
  lstarq$parameters$unstandardized%>%mutate(task = "quantity", phase = "Phase 1")%>%filter(paramHeader== "S14.ON"),
  lstarg$parameters$unstandardized%>%mutate(task = "gaze_following", phase = "Phase 1")%>%filter(paramHeader== "S14.ON"),

  lstarc2$parameters$unstandardized%>%mutate(task = "causality", phase = "Phase 2")%>%filter(paramHeader== "S14.ON"),
  lstari2$parameters$unstandardized%>%mutate(task = "inference", phase = "Phase 2")%>%filter(paramHeader== "S14.ON"),
  lstarq2$parameters$unstandardized%>%mutate(task = "quantity", phase = "Phase 2")%>%filter(paramHeader== "S14.ON"),
  lstarg2$parameters$unstandardized%>%mutate(task = "gaze_following", phase = "Phase 2")%>%filter(paramHeader== "S14.ON"),
  lstard2$parameters$unstandardized%>%mutate(task = "delay_of_gratification", phase = "Phase 2")%>%filter(paramHeader== "S14.ON")
  )%>%
  mutate(task = recode(task,
    gaze_following = "Gaze following",
    causality = "Causal inference",
    inference = "Inference by exclusion",
    delay_of_gratification = "Delay of gratification",
    quantity = "Quantity discrimination",
    switching = "Strategy switching"
  ))%>%
  mutate(task = factor(task, levels = c("Gaze following", "Causal inference","Inference by exclusion" ,"Quantity discrimination", "Delay of gratification")))

pbeta <- ggplot(lstar_beta,aes(x = task, y = est, col = phase))+
    geom_pointrange(aes(ymin = lower_2.5ci, ymax = upper_2.5ci), position = position_dodge(width = .7), size = .5)+
  #geom_hline(yintercept = 0,lty = 3, alpha = .75)+
  geom_hline(yintercept = 0.9,lty = 3, alpha = .5)+
  geom_hline(yintercept = 1,lty = 3, alpha = 1)+
  theme_few()+
  ylim(-.5,1.1)+
  #facet_wrap(~task)+
  labs(x = "", y = "LST model estimate")+
  scale_color_discrete(name = "")+
  scale_shape(name = "Phase")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  #theme(legend.position = "bottom", legend.box = "vertical")+
  theme(#legend.text=element_text(size=7), legend.key.size = unit(0.4,"cm"),
    legend.position = c(0.4,0.2), legend.direction = "horizontal", legend.spacing.x = unit(0, 'cm'), legend.spacing.y = unit(0, 'cm'))
```

(ref:figlab1) Posterior means of auto-regressive $\beta$ coefficients for LST-AR models with 95% CrI based on data from N = 43 participants.

```{r lstarbeta, fig.height = 3, fig.width= 10, fig.cap = "(ref:figlab1)", out.width="100%"}
pbeta
```

## Simulations

```{r}
sim <- read.table("../../models and documentation Jana/Simulation/Simulation_results_long.txt",sep="\t",header=TRUE)%>%
  mutate(model = as.character(as.numeric(factor(files))),
         parameter = factor(kind))

psim <- sim%>%
  select(model,parameter, cover_95, peb,mse,bias,seb)%>%
  pivot_longer(cols = c(cover_95, peb,mse,bias,seb), values_to = "value", names_to = "measure")%>%
  mutate(uline = ifelse(measure == "cover_95", .98, 
                        ifelse(measure == "peb" | measure == "seb", .1, NA)),
         lline = ifelse(measure == "cover_95", .91,NA))%>%
  mutate(measure = recode(measure, 
                          cover_95 = "95%-Coverage",
                          peb = "Rel. Parameter\n Estimation Bias",
                          mse = "Mean Squared\n Error",
                          bias = "Bias",
                          seb = "Rel. Standard\n Error Bias"))
```

### Simulation setup

The purpose of the simulations was to check whether the results of the present study can be trusted given the models and the sample size. The results thus only apply to this specific case and (Bayesian) estimation process and do not constitute general recommendations to be used during study planning in the future.  

Data were generated and estimated using MPlus 8.4. Data-generating values are based on the real-data application of the models to the available subset of the data at the time of conducting the simulation study. That is, data were simulated for 40 individuals (N) observed across 9 or 12 measurement occasions, with 5 or 7 observed categories per indicator. 1000 replications were simulated. Data estimation took place using the MPlus default priors. In case of LST models for one construct, default priors were compared with IG(0.001, 0.001) priors set on all variance parameters (model did not include latent covariances). Two chains with a minimum of 5,000 iterations per chain and a thinning factor of 10 was applied (i.e. at last 50,000 iterations of which only every 10th was used for constructing the posterior distribution). Convergence was assumed and estimation stopped when the PSR fell below 1.05 for the first time after the minimum number of iterations was reached.

### Simulation results

In the following, the 95% coverage rate, the Relative Parameter Estimation Bias (deviation between average estimate and population parameter divided by the population parameter), the Mean Squared Error, absolute bias, as well as Relative Standard Error Bias are displayed for every simulated model (Supplementary Figure \@ref(fig:sim1) - \@ref(fig:sim4)). Relative parameter and standard error biases below 0.1 (that is $< 10 \%$) are considered acceptable.

Parameters in the latent state models for one construct are estimated accurately, with relative biases below a cutoff of 10% bias and good coverage rates, irrespective of simulating 7 or 5 observed ordered categories for the observed indicators.

Latent state-trait models for one construct with latent state residual variances fixed across time show good estimation performance, with both default or adapted inverse gamma priors. When freely estimating latent state residual variances across time points (i.e., no restrictions on variances), model parameters are not estimated accurately under the simulated sample sizes, irrespective of the prior choice.

Latent state-trait models for a combination of two constructs with latent variances and covariances of the state residual variances restricted to equality across time points work well. Models with freely estimated variances and covariances do not show good estimation performance. The same holds for the latent state model with two constructs and freely estimated variances and covariances.

In conclusion, latent state models for one construct (freely estimated variances) as well as latent state-trait models for one or two constructs with state residual variances restricted across time exhibit good estimation performance (low biases, high coverage) and application under the simulated samples size should be feasible in practice.

```{r sim1, fig.height=3.5, fig.cap = "Results of the simulation study for the latent state (LS) model including one construct with freely estimated latent state variances and covariances, spanning 9 measurement time points. Simulated sample size was N = 40. Ordinal indicators were simulated with 5 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "2")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State models: One construct",
          subtitle = "Freely varying state variances and covariances across time points. 5 ordered categories")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))
```

```{r sim3, fig.height=3.5, fig.cap = "Results of the simulation study for the latent state (LS) model including one construct with freely estimated latent atate variances and covariances, spanning 9 measurement time points. Simulated sample size was N = 40. Ordinal indicators were simulated with 7 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "3")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State models: One construct",
          subtitle = "Freely varying state variances and covariances across time points. 7 ordered categories")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))

```

```{r sim7, fig.height=3.5, fig.cap = " Results of the simulation study for the latent state-trait (LST) model including one construct with latent state residual variances fixed to be equal across time, spanning 9 measurement time points. Simulated sample size was N = 40. MPlus default priors. Ordinal indicators were simulated with 7 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "7")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State-Trait models: One construct",
          subtitle = "Fixed state residual variances across time points with default priors")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))

```

```{r sim6, fig.height=3.5, fig.cap = "Results of the simulation study for the latent state-trait (LST) model including one construct with latent state residual variances fixed to be equal across time, spanning 9 measurement time points. Simulated sample size was N = 40. Inverse gamma priors IG(0.001,0.001) for all variances. Ordinal indicators were simulated with 7 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "6")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State-Trait models: One construct",
          subtitle = "Fixed state residual variances across time points with inverse gamma priors")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))

```

```{r sim8, fig.height=3.5, fig.cap = "Results of the simulation study for the latent state-trait (LST) model including one construct with latent state residual variances freely estimates across time, spanning 9 measurement time points. Simulated sample size was N = 40. Ordinal indicators were simulated with 7 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "8")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State-Trait models: One construct",
          subtitle = "Free state residual variances across time points with default priors")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))

```

```{r sim9, fig.height=3.5, fig.cap = "Results of the simulation study for the latent state-trait (LST) model including one construct with latent state residual variances freely estimates across time, spanning 9 measurement time points. Simulated sample size was N = 40. Inverse gamma priors IG(0.001,0.001) for all variances. Ordinal indicators were simulated with 7 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "9")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State-Trait models: One construct",
          subtitle = "Free state residual variances across time points with inverse gamma priors")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))

```

```{r sim2, fig.height=3.5, fig.cap = "Results of the simulation study for the latent state model including two constructs with latent state variances freely estimates across time, spanning 9 measurement time points. Simulated sample size was N = 40. Ordinal indicators were simulated with 7 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "1")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State models: Two constructs",
          subtitle = "Free state variances and covariances across time points and default priors")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))

```

```{r sim5, fig.height=3.5, fig.cap = "Results of the simulation study for the latent state-trait (LST) model including two constructs with free latent state residual variances across time, spanning 9 measurement time points. Simulated sample size was N = 40. Ordinal indicators were simulated with 7 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "5")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State-Trait models: Two constructs",
          subtitle = "Free state residual variances and covariances across time points")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))

```

```{r sim4, fig.height=3.5, fig.cap = "Results of the simulation study for the latent state-trait (LST) model including two constructs with fixed latent state residual variances across time, spanning 9 measurement time points. Simulated sample size was N = 40. Ordinal indicators were simulated with 7 ordered categories. Boxplots display the distribution of the respective statistic across different parameters of the same parameter type. Whiskers show the minimum and the maximum. Red dots show ouliers. The box ranges from the 25\\% to the 75\\% quantile. Black line shows the median.", out.width="100%"}
psim %>%
  filter(model == "4")%>%
  ggplot(.,aes(x=parameter,y=value, fill = parameter)) + 
  geom_boxplot(outlier.colour="red", #outlier.shape=8,
               outlier.size=0.2,notch=F, alpha = .75)+
  geom_hline(aes(yintercept = uline), col = "red", lty = 2)+
  geom_hline(aes(yintercept = lline), col = "red", lty = 2)+
  facet_wrap_custom(measure~., scales = "free", nrow = 1, scale_overrides = list(
    scale_override(1, scale_y_continuous(limits = c(0.8, 1))),
    scale_override(2, scale_y_continuous(limits = c(-1,1))),
    scale_override(3, scale_y_continuous(limits = c(0,2))),
    scale_override(4, scale_y_continuous(limits = c(0,0.5))),
    scale_override(5, scale_y_continuous(limits = c(0,1)))
  ))+
  ggtitle("Latent State-Trait models: Two constructs",
          subtitle = "Fixed state residual variances and covariances across time points")+
  scale_fill_manual(values=c("#003366", "#006699","#3399CC","#99CCFF","#CCFFFF"))+
  guides(fill = "none")+
  labs(x = "", y = "")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=45,hjust = 1))

```

\newpage

# Supplementary References

::: {#refs}
:::
